<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.147.1"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="新闻推荐系统后端"><meta itemprop=description content="stay hungry, stay humble"><meta name=description content="stay hungry, stay humble"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://eSparkL.github.io/imgs/Sherry.jpg"><meta itemprop=keywords content="软件工程,Django"><meta property="og:type" content="article"><meta property="og:title" content="新闻推荐系统后端"><meta property="og:description" content="stay hungry, stay humble"><meta property="og:image" content="/imgs/Sherry.jpg"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://eSparkL.github.io/study/10-%E6%96%B0%E9%97%BB%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%90%8E%E7%AB%AF/"><meta property="og:site_name" content="Syek.com"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="eSparkL"><meta property="article:published_time" content="2025-05-21 00:10:45 +0800 CST"><meta property="article:modified_time" content="2025-05-21 00:10:45 +0800 CST"><link type=text/css rel=stylesheet href=https://eSparkL.github.io/js/3rd/font-awesome/6.7.2/css/all.min.css><link type=text/css rel=stylesheet href=https://eSparkL.github.io/js/3rd/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://eSparkL.github.io/js/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href="/css/main.min.css?=1748535998"><style type=text/css>.post-footer hr:after{content:"~ 我可是有底线的哟 ~"}.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><link rel=stylesheet type=text/css href="/css/custom_style.css?=1748535998"><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>新闻推荐系统后端 - Syek.com</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Syek.com</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>见证成长的地方</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-flinks"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-thumbs-up hvr-icon"></i>友情链接</a></li><li class="menu-item menu-item-example"><a href=/ class="menus-parent hvr-icon-pulse" rel=section><i class="fa fa-angles-down hvr-icon"></i>语法示例
<span class=menu-item-shrink-icon><i class="fa fa-angle-right"></i></span></a><ul class=menu-children><li class=menu-child-item><a href=/demo/syntax-highlighting.html class=hvr-icon-pulse rel=section><i class="fa hvr-icon"></i>语法高亮</a></li><li class=menu-child-item><a href=/demo/math-formula.html class=hvr-icon-pulse rel=section><i class="fa hvr-icon"></i>数学公式</a></li><li class=menu-child-item><a href=/demo/mermaid-charts.html class=hvr-icon-pulse rel=section><i class="fa hvr-icon"></i>流程图</a></li></ul></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>13</span></a></li><li class="menu-item menu-item-guide"><a href=/post/ class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>hugo-next手册</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#常用命令汇总>常用命令汇总</a></li><li><a href=#前端架构搭建>前端架构搭建</a><ul><li><a href=#node-和-npm-和-vue-版本>node 和 npm 和 vue 版本</a></li></ul></li><li><a href=#jwt前后端交互>JWT前后端交互</a></li><li><a href=#跨域问题>跨域问题</a></li><li><a href=#前端登录静态界面>前端登录静态界面</a></li><li><a href=#自定义icon实现>自定义icon实现</a></li><li><a href=#django局域网访问>Django局域网访问</a></li><li><a href=#后端登录功能逻辑实现>后端登录功能逻辑实现</a></li><li><a href=#上传github>上传GitHub</a><ul><li><a href=#requirementstxt>requirements.txt</a></li><li><a href=#使用env管理环境变量>使用.env管理环境变量</a></li></ul></li><li><a href=#新闻浏览>新闻浏览</a><ul><li><a href=#基于游标的新闻列表分页>基于游标的新闻列表分页</a></li><li><a href=#单条新闻详情>单条新闻详情</a></li><li><a href=#标签列表>标签列表</a></li></ul></li><li><a href=#兴趣推送>兴趣推送</a><ul><li><a href=#实现过程>实现过程</a></li><li><a href=#迁移数据库>迁移数据库</a><ul><li><a href=#使用命令行失败>使用命令行（失败）</a></li><li><a href=#使用mysql-workbench成功>使用mysql workbench（成功）</a></li></ul></li><li><a href=#邮件发送功能>邮件发送功能</a><ul><li><a href=#开通smtp服务>开通SMTP服务</a></li><li><a href=#邮件发送测试>邮件发送测试</a></li></ul></li><li><a href=#定时邮件发送django-background-tasks-失败>定时邮件发送（django-background-tasks 失败）</a></li><li><a href=#定时邮件发送celery--celery-beat>定时邮件发送（Celery + Celery Beat）</a></li><li><a href=#根据用户兴趣和时段推送新闻>根据用户兴趣和时段推送新闻</a></li><li><a href=#时区问题>时区问题</a></li></ul></li><li><a href=#修改推送设置>修改推送设置</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=eSparkL src=/imgs/img-lazy-loading.gif data-src=/imgs/Sherry.jpg><p class=site-author-name itemprop=name>eSparkL</p><div class=site-description itemprop=description>stay hungry, stay humble</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>13</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>16</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>31</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/eSparkL title="Github → https://github.com/eSparkL" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github
</a></span><span class=links-of-social-item><a href="https://mpbeta.csdn.net/mp_blog/manage/column/allColumnList?spm=1011.2415.3001.10338" title="CSDN专栏 → https://mpbeta.csdn.net/mp_blog/manage/column/allColumnList?spm=1011.2415.3001.10338" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>
CSDN专栏</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>主题：Hugo-NexT</a></li></ul></div><div class="mydefined animated" itemprop=custom><span>支持自定义CSS和Sidebar布局啦💄💄💄</span></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate="2025-05-19 23:42:02 +0800 CST"></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=17008></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=42></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate="2025-05-27 17:55:22 +0800 CST"></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-i18n-translate class=button title=多语言翻译><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/hugo-next rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg>
</a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://eSparkL.github.io/study/10-%E6%96%B0%E9%97%BB%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%90%8E%E7%AB%AF/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/Sherry.jpg"><meta itemprop=name content="eSparkL"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="eSparkL"><meta itemprop=description content="stay hungry, stay humble"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="新闻推荐系统后端"><meta itemprop=description content="
    后端：Django
参考：

    https://www.bilibili.com/video/BV19spseGE9Y?spm_id_from=333.788.videopod.episodes&vd_source=ae5b8f4c462b3f90ff8881691bdf718b&p=2
    
    
    

  "></span><header class=post-header><h1 class=post-title itemprop="name headline">新闻推荐系统后端
<a href=https://github.com/user-name/repo-name/tree/branch-name/subdirectory-name/study/10-%e6%96%b0%e9%97%bb%e6%8e%a8%e8%8d%90%e7%b3%bb%e7%bb%9f%e5%90%8e%e7%ab%af/index.md rel="noopener external nofollow noreferrer" target=_blank class="exturl post-edit-link" title=编辑><i class="fa fa-pen-nib"></i></a></h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2025-05-21 00:10:45 +08:00" itemprop="dateCreated datePublished" datetime="2025-05-21 00:10:45 +0800 CST">2025-05-21
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/%E5%A4%A7%E4%BD%9C%E4%B8%9A/ itemprop=url rel=index><span itemprop=name>大二/大作业</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>6568</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>14分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=busuanzi_value_page_pv data-path=/study/10-%E6%96%B0%E9%97%BB%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%90%8E%E7%AB%AF/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><blockquote><p>后端：Django</p><p>参考：
<a href="https://www.bilibili.com/video/BV19spseGE9Y?spm_id_from=333.788.videopod.episodes&amp;vd_source=ae5b8f4c462b3f90ff8881691bdf718b&amp;p=2" title="https://www.bilibili.com/video/BV19spseGE9Y?spm_id_from=333.788.videopod.episodes&vd_source=ae5b8f4c462b3f90ff8881691bdf718b&p=2" rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://www.bilibili.com/video/BV19spseGE9Y?spm_id_from=333.788.videopod.episodes&vd_source=ae5b8f4c462b3f90ff8881691bdf718b&p=2
    
    <i class="fa fa-external-link-alt"></i></a></p></blockquote><a id=more></a><h2 id=常用命令汇总>常用命令汇总
<a class=header-anchor href=#%e5%b8%b8%e7%94%a8%e5%91%bd%e4%bb%a4%e6%b1%87%e6%80%bb></a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11>11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12>12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13>13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14>14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15>15</a>
</span><span class=lnt id=hl-0-16><a class=lnlinks href=#hl-0-16>16</a>
</span><span class=lnt id=hl-0-17><a class=lnlinks href=#hl-0-17>17</a>
</span><span class=lnt id=hl-0-18><a class=lnlinks href=#hl-0-18>18</a>
</span><span class=lnt id=hl-0-19><a class=lnlinks href=#hl-0-19>19</a>
</span><span class=lnt id=hl-0-20><a class=lnlinks href=#hl-0-20>20</a>
</span><span class=lnt id=hl-0-21><a class=lnlinks href=#hl-0-21>21</a>
</span><span class=lnt id=hl-0-22><a class=lnlinks href=#hl-0-22>22</a>
</span><span class=lnt id=hl-0-23><a class=lnlinks href=#hl-0-23>23</a>
</span><span class=lnt id=hl-0-24><a class=lnlinks href=#hl-0-24>24</a>
</span><span class=lnt id=hl-0-25><a class=lnlinks href=#hl-0-25>25</a>
</span><span class=lnt id=hl-0-26><a class=lnlinks href=#hl-0-26>26</a>
</span><span class=lnt id=hl-0-27><a class=lnlinks href=#hl-0-27>27</a>
</span><span class=lnt id=hl-0-28><a class=lnlinks href=#hl-0-28>28</a>
</span><span class=lnt id=hl-0-29><a class=lnlinks href=#hl-0-29>29</a>
</span><span class=lnt id=hl-0-30><a class=lnlinks href=#hl-0-30>30</a>
</span><span class=lnt id=hl-0-31><a class=lnlinks href=#hl-0-31>31</a>
</span><span class=lnt id=hl-0-32><a class=lnlinks href=#hl-0-32>32</a>
</span><span class=lnt id=hl-0-33><a class=lnlinks href=#hl-0-33>33</a>
</span><span class=lnt id=hl-0-34><a class=lnlinks href=#hl-0-34>34</a>
</span><span class=lnt id=hl-0-35><a class=lnlinks href=#hl-0-35>35</a>
</span><span class=lnt id=hl-0-36><a class=lnlinks href=#hl-0-36>36</a>
</span><span class=lnt id=hl-0-37><a class=lnlinks href=#hl-0-37>37</a>
</span><span class=lnt id=hl-0-38><a class=lnlinks href=#hl-0-38>38</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## 创建Django项目</span>
</span></span><span class=line><span class=cl>django-admin startproject project_name
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 创建Django应用</span>
</span></span><span class=line><span class=cl>python manage.py startapp app_name
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 生成数据库迁移文件</span>
</span></span><span class=line><span class=cl>python manage.py makemigrations <span class=o>[</span>app_name<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 执行迁移文件</span>
</span></span><span class=line><span class=cl>python manage.py migrate <span class=o>[</span>app_name<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 查看迁移状态（[ ] 表示未应用 [X] 表示已应用）</span>
</span></span><span class=line><span class=cl>python manage.py showmigrations <span class=o>[</span>app_name<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 清除缓存</span>
</span></span><span class=line><span class=cl>python manage.py clearcache
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 测试用开发服务器</span>
</span></span><span class=line><span class=cl>python manage.py runserver
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 查看已注册路由</span>
</span></span><span class=line><span class=cl>python manage.py show_urls
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启动 Redis</span>
</span></span><span class=line><span class=cl>redis-server.exe redis.windows.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在项目终端进行 Redis 连接测试</span>
</span></span><span class=line><span class=cl>redis-cli ping
</span></span><span class=line><span class=cl><span class=c1># 如有跟着博客配置密码</span>
</span></span><span class=line><span class=cl>redis-cli -a your_password ping
</span></span><span class=line><span class=cl><span class=c1># 返回 PONG 即说明Redis成功运行</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启动 Celery Worker（添加参数 -P） </span>
</span></span><span class=line><span class=cl>celery -A nrsmAPI_project worker -l info -P eventlet
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 再启动 Celery Beat</span>
</span></span><span class=line><span class=cl>celery -A nrsmAPI_project beat --loglevel<span class=o>=</span>info</span></span></code></pre></td></tr></table></div></div><p>开发接口尽可能遵循Restful规范：
<img src=/imgs/img-lazy-loading.gif data-src=image.png alt="alt text"></p><h2 id=前端架构搭建>前端架构搭建
<a class=header-anchor href=#%e5%89%8d%e7%ab%af%e6%9e%b6%e6%9e%84%e6%90%ad%e5%bb%ba></a></h2><h3 id=node-和-npm-和-vue-版本>node 和 npm 和 vue 版本
<a class=header-anchor href=#node-%e5%92%8c-npm-%e5%92%8c-vue-%e7%89%88%e6%9c%ac></a></h3><p>(venv) D:\administrator\College\课后笔记\SE-软工\newsAPI_project>node -v
v22.11.0</p><p>(venv) D:\administrator\College\课后笔记\SE-软工\newsAPI_project>npm -v
10.9.0</p><p>(venv) D:\administrator\College\课后笔记\SE-软工\newsAPI_project>vue &ndash;version
@vue/cli 5.0.8</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## 启动项目</span>
</span></span><span class=line><span class=cl>npm run serve</span></span></code></pre></td></tr></table></div></div><h2 id=jwt前后端交互>JWT前后端交互
<a class=header-anchor href=#jwt%e5%89%8d%e5%90%8e%e7%ab%af%e4%ba%a4%e4%ba%92></a></h2><p>DRF框架</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1>1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2>2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3>3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4>4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## 安装drf</span>
</span></span><span class=line><span class=cl>pip install djangorestframework -i https://pypi.tuna.tsinghua.edu.cn/simple
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 安装drf-jwt</span>
</span></span><span class=line><span class=cl>pip install djangorestframework-jwt  -i https://pypi.tuna.tsinghua.edu.cn/simple</span></span></code></pre></td></tr></table></div></div><h2 id=跨域问题>跨域问题
<a class=header-anchor href=#%e8%b7%a8%e5%9f%9f%e9%97%ae%e9%a2%98></a></h2><p>前后端不在同一个域</p><p><img src=/imgs/img-lazy-loading.gif data-src=image-1.png alt="alt text"></p><p>CORS（跨域资源共享，Cross-Origin Resource Sharing）是一种跨域访问的机制，可让Ajax实现跨域
访问。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1>1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## 安装django-cors-headers库</span>
</span></span><span class=line><span class=cl>pip install django-cors-headers -i https://pypi.tuna.tsinghua.edu.cn/simple</span></span></code></pre></td></tr></table></div></div><h2 id=前端登录静态界面>前端登录静态界面
<a class=header-anchor href=#%e5%89%8d%e7%ab%af%e7%99%bb%e5%bd%95%e9%9d%99%e6%80%81%e7%95%8c%e9%9d%a2></a></h2><p>attest文件夹下方静态资源，如全局css样式、网页背景图片等</p><p>view下每一个.vue文件是一个页面，新建Login.vue</p><p>router/index.js中加上Login.vue的路由
<img src=/imgs/img-lazy-loading.gif data-src=image-2.png alt="alt text"></p><p>App.vue相当于是主界面
<img src=/imgs/img-lazy-loading.gif data-src=image-4.png alt="alt text"></p><p>App.vue设置下全局样式
<img src=/imgs/img-lazy-loading.gif data-src=image-3.png alt="alt text"></p><h2 id=自定义icon实现>自定义icon实现
<a class=header-anchor href=#%e8%87%aa%e5%ae%9a%e4%b9%89icon%e5%ae%9e%e7%8e%b0></a></h2><p>（略过）</p><h2 id=django局域网访问>Django局域网访问
<a class=header-anchor href=#django%e5%b1%80%e5%9f%9f%e7%bd%91%e8%ae%bf%e9%97%ae></a></h2><blockquote><p>参考博客：
<a href=https://blog.csdn.net/sandalphon4869/article/details/107601765 title=https://blog.csdn.net/sandalphon4869/article/details/107601765 rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://blog.csdn.net/sandalphon4869/article/details/107601765
<i class="fa fa-external-link-alt"></i></a></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python manage.py runserver 0.0.0.0:8000</span></span></code></pre></td></tr></table></div></div><h2 id=后端登录功能逻辑实现>后端登录功能逻辑实现
<a class=header-anchor href=#%e5%90%8e%e7%ab%af%e7%99%bb%e5%bd%95%e5%8a%9f%e8%83%bd%e9%80%bb%e8%be%91%e5%ae%9e%e7%8e%b0></a></h2><p>流程：</p><ul><li>前端传递参数</li><li>后端验证</li><li>验证成功后，生成jwt</li><li>将状态码和token传回给前端</li><li>前段将token加入请求头的AUTHORIZATION字段中</li></ul><blockquote><p>注意model中的属性名要和view中的一致，否则会出现500错误。
先建数据库，再写后端容易出现此类问题</p><p>以及如果重新执行迁移文件发现无法No migrations to apply.，则在数据库中drop掉django_migrations表（delete对应迁移记录也可以），再重新运行python manage.py migrate [app]</p></blockquote><h2 id=上传github>上传GitHub
<a class=header-anchor href=#%e4%b8%8a%e4%bc%a0github></a></h2><h3 id=requirementstxt>requirements.txt
<a class=header-anchor href=#requirementstxt></a></h3><p>将当前功能git到仓库，并撰写README.md文档</p><p>环境依赖文件生成</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1>1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2>2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3>3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4>4</a>
</span><span class=lnt id=hl-5-5><a class=lnlinks href=#hl-5-5>5</a>
</span><span class=lnt id=hl-5-6><a class=lnlinks href=#hl-5-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## 法一：环境中所有的包</span>
</span></span><span class=line><span class=cl>pip freeze &gt; requirements.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 法二：如果仅保留项目必需的包，可使用pipreqs</span>
</span></span><span class=line><span class=cl>pip install pipreqs <span class=c1>## 安装pipreqs（如已安装则跳过）</span>
</span></span><span class=line><span class=cl>pipreqs .</span></span></code></pre></td></tr></table></div></div><h3 id=使用env管理环境变量>使用.env管理环境变量
<a class=header-anchor href=#%e4%bd%bf%e7%94%a8env%e7%ae%a1%e7%90%86%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f></a></h3><p>Django项目根目录下的<code>settings.py</code>文件存储有很多敏感信息，包括数据库的ip、密码，密钥，邮件服务密钥等。在提交到GitHub前，应先对其进行处理。</p><p>创建<code>.env</code>文件，定义所需的环境变量，通常与manage.py文件在同目录下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a class=lnlinks href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a class=lnlinks href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a class=lnlinks href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a class=lnlinks href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a class=lnlinks href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a class=lnlinks href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a class=lnlinks href=#hl-6-12>12</a>
</span><span class=lnt id=hl-6-13><a class=lnlinks href=#hl-6-13>13</a>
</span><span class=lnt id=hl-6-14><a class=lnlinks href=#hl-6-14>14</a>
</span><span class=lnt id=hl-6-15><a class=lnlinks href=#hl-6-15>15</a>
</span><span class=lnt id=hl-6-16><a class=lnlinks href=#hl-6-16>16</a>
</span><span class=lnt id=hl-6-17><a class=lnlinks href=#hl-6-17>17</a>
</span><span class=lnt id=hl-6-18><a class=lnlinks href=#hl-6-18>18</a>
</span><span class=lnt id=hl-6-19><a class=lnlinks href=#hl-6-19>19</a>
</span><span class=lnt id=hl-6-20><a class=lnlinks href=#hl-6-20>20</a>
</span><span class=lnt id=hl-6-21><a class=lnlinks href=#hl-6-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>## .env
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>## Django 设置
</span></span><span class=line><span class=cl>SECRET_KEY=
</span></span><span class=line><span class=cl>DEBUG=False
</span></span><span class=line><span class=cl>TIMEZONE=
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>## 允许的域名
</span></span><span class=line><span class=cl>ALLOWED_HOSTS=
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>## 数据库配置
</span></span><span class=line><span class=cl>ENGINE=
</span></span><span class=line><span class=cl>NAME=
</span></span><span class=line><span class=cl>USER=
</span></span><span class=line><span class=cl>PASSWORD=
</span></span><span class=line><span class=cl>HOST=
</span></span><span class=line><span class=cl>PORT=
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>## Celery / Redis
</span></span><span class=line><span class=cl>CELERY_BROKER_URL=
</span></span><span class=line><span class=cl>CELERY_RESULT_BACKEND=</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1>1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2>2</a>
</span><span class=lnt id=hl-7-3><a class=lnlinks href=#hl-7-3>3</a>
</span><span class=lnt id=hl-7-4><a class=lnlinks href=#hl-7-4>4</a>
</span><span class=lnt id=hl-7-5><a class=lnlinks href=#hl-7-5>5</a>
</span><span class=lnt id=hl-7-6><a class=lnlinks href=#hl-7-6>6</a>
</span><span class=lnt id=hl-7-7><a class=lnlinks href=#hl-7-7>7</a>
</span><span class=lnt id=hl-7-8><a class=lnlinks href=#hl-7-8>8</a>
</span><span class=lnt id=hl-7-9><a class=lnlinks href=#hl-7-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## 安装python-dotenv库，用于读取.env中的环境变量</span>
</span></span><span class=line><span class=cl>pip install python-dotenv
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## settings.py</span>
</span></span><span class=line><span class=cl>import os
</span></span><span class=line><span class=cl>from dotenv import load_dotenv
</span></span><span class=line><span class=cl>load_dotenv<span class=o>()</span> <span class=c1>## 加载 .env 文件</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 使用 os.getenv(&#39;.env中对应的键&#39;) 替换敏感信息</span></span></span></code></pre></td></tr></table></div></div><h2 id=新闻浏览>新闻浏览
<a class=header-anchor href=#%e6%96%b0%e9%97%bb%e6%b5%8f%e8%a7%88></a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1>1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2>2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3>3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4>4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5>5</a>
</span><span class=lnt id=hl-8-6><a class=lnlinks href=#hl-8-6>6</a>
</span><span class=lnt id=hl-8-7><a class=lnlinks href=#hl-8-7>7</a>
</span><span class=lnt id=hl-8-8><a class=lnlinks href=#hl-8-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## 创建空迁移文件(由于需要在建表的同时插入初始值，非空限制)</span>
</span></span><span class=line><span class=cl>python manage.py makemigrations --empty news
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 安装Django扩展包（Django版本从Django-4.1.13变为了django-4.2.21）</span>
</span></span><span class=line><span class=cl>pip install django-extensions
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 查看已注册路由</span>
</span></span><span class=line><span class=cl>python manage.py show_urls</span></span></code></pre></td></tr></table></div></div><h3 id=基于游标的新闻列表分页>基于游标的新闻列表分页
<a class=header-anchor href=#%e5%9f%ba%e4%ba%8e%e6%b8%b8%e6%a0%87%e7%9a%84%e6%96%b0%e9%97%bb%e5%88%97%e8%a1%a8%e5%88%86%e9%a1%b5></a></h3><h3 id=单条新闻详情>单条新闻详情
<a class=header-anchor href=#%e5%8d%95%e6%9d%a1%e6%96%b0%e9%97%bb%e8%af%a6%e6%83%85></a></h3><p>出现了500，服务器内部无法响应的问题，多半与数据库连接有关</p><p>打印错误<code> Unknown column 'news_tag.id' in 'field list'</code></p><p>在终端执行以下语句，返回正常，排除了数据库连接/连接错误的问题</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1> 1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2> 2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3> 3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4> 4</a>
</span><span class=lnt id=hl-9-5><a class=lnlinks href=#hl-9-5> 5</a>
</span><span class=lnt id=hl-9-6><a class=lnlinks href=#hl-9-6> 6</a>
</span><span class=lnt id=hl-9-7><a class=lnlinks href=#hl-9-7> 7</a>
</span><span class=lnt id=hl-9-8><a class=lnlinks href=#hl-9-8> 8</a>
</span><span class=lnt id=hl-9-9><a class=lnlinks href=#hl-9-9> 9</a>
</span><span class=lnt id=hl-9-10><a class=lnlinks href=#hl-9-10>10</a>
</span><span class=lnt id=hl-9-11><a class=lnlinks href=#hl-9-11>11</a>
</span><span class=lnt id=hl-9-12><a class=lnlinks href=#hl-9-12>12</a>
</span><span class=lnt id=hl-9-13><a class=lnlinks href=#hl-9-13>13</a>
</span><span class=lnt id=hl-9-14><a class=lnlinks href=#hl-9-14>14</a>
</span><span class=lnt id=hl-9-15><a class=lnlinks href=#hl-9-15>15</a>
</span><span class=lnt id=hl-9-16><a class=lnlinks href=#hl-9-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python manage.py shell
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>from news.models import News
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 查询 id=1 的新闻对象</span>
</span></span><span class=line><span class=cl><span class=nv>news</span> <span class=o>=</span> News.objects.get<span class=o>(</span><span class=nv>id</span><span class=o>=</span>1<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 打印新闻标题等信息</span>
</span></span><span class=line><span class=cl>print<span class=o>(</span>news.id<span class=o>)</span>
</span></span><span class=line><span class=cl>print<span class=o>(</span>news.title<span class=o>)</span>
</span></span><span class=line><span class=cl>print<span class=o>(</span>news.body<span class=o>)</span>
</span></span><span class=line><span class=cl>print<span class=o>(</span>news.pub_time<span class=o>)</span>
</span></span><span class=line><span class=cl>print<span class=o>(</span>news.website<span class=o>)</span>
</span></span><span class=line><span class=cl>print<span class=o>(</span>news.url<span class=o>)</span>
</span></span><span class=line><span class=cl>print<span class=o>(</span>news.images<span class=o>)</span>
</span></span><span class=line><span class=cl>print<span class=o>(</span>news.summary<span class=o>)</span></span></span></code></pre></td></tr></table></div></div><p>问题出在news_tag表与model定义不匹配，缺少了Django自加的id字段。解决方法：</p><ol><li>手动在数据库增加id字段。但由于已经有外键依赖，总之就是不给我加。</li><li>修改model定义。但似乎修改后不行</li><li>找出哪里用到了id。√</li></ol><p>发现是序列化时，尽管没有显式访问id字段，但是在某个语句背后有访问到。尝试绕过id字段的访问即可。AI修改如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1>1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2>2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3>3</a>
</span><span class=lnt id=hl-10-4><a class=lnlinks href=#hl-10-4>4</a>
</span><span class=lnt id=hl-10-5><a class=lnlinks href=#hl-10-5>5</a>
</span><span class=lnt id=hl-10-6><a class=lnlinks href=#hl-10-6>6</a>
</span><span class=lnt id=hl-10-7><a class=lnlinks href=#hl-10-7>7</a>
</span><span class=lnt id=hl-10-8><a class=lnlinks href=#hl-10-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>NewsSerializer</span><span class=p>(</span><span class=n>serializers</span><span class=o>.</span><span class=n>ModelSerializer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>tags</span> <span class=o>=</span> <span class=n>serializers</span><span class=o>.</span><span class=n>SerializerMethodField</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>Meta</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span> <span class=o>=</span> <span class=n>News</span>
</span></span><span class=line><span class=cl>        <span class=n>fields</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>,</span> <span class=s1>&#39;title&#39;</span><span class=p>,</span> <span class=s1>&#39;body&#39;</span><span class=p>,</span> <span class=s1>&#39;pub_time&#39;</span><span class=p>,</span> <span class=s1>&#39;website&#39;</span><span class=p>,</span> <span class=s1>&#39;url&#39;</span><span class=p>,</span> <span class=s1>&#39;images&#39;</span><span class=p>,</span> <span class=s1>&#39;tags&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_tags</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>obj</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>list</span><span class=p>(</span><span class=n>obj</span><span class=o>.</span><span class=n>newstag_set</span><span class=o>.</span><span class=n>select_related</span><span class=p>(</span><span class=s1>&#39;tag&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>values_list</span><span class=p>(</span><span class=s1>&#39;tag__ch_name&#39;</span><span class=p>,</span> <span class=n>flat</span><span class=o>=</span><span class=kc>True</span><span class=p>))</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1> 1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2> 2</a>
</span><span class=lnt id=hl-11-3><a class=lnlinks href=#hl-11-3> 3</a>
</span><span class=lnt id=hl-11-4><a class=lnlinks href=#hl-11-4> 4</a>
</span><span class=lnt id=hl-11-5><a class=lnlinks href=#hl-11-5> 5</a>
</span><span class=lnt id=hl-11-6><a class=lnlinks href=#hl-11-6> 6</a>
</span><span class=lnt id=hl-11-7><a class=lnlinks href=#hl-11-7> 7</a>
</span><span class=lnt id=hl-11-8><a class=lnlinks href=#hl-11-8> 8</a>
</span><span class=lnt id=hl-11-9><a class=lnlinks href=#hl-11-9> 9</a>
</span><span class=lnt id=hl-11-10><a class=lnlinks href=#hl-11-10>10</a>
</span><span class=lnt id=hl-11-11><a class=lnlinks href=#hl-11-11>11</a>
</span><span class=lnt id=hl-11-12><a class=lnlinks href=#hl-11-12>12</a>
</span><span class=lnt id=hl-11-13><a class=lnlinks href=#hl-11-13>13</a>
</span><span class=lnt id=hl-11-14><a class=lnlinks href=#hl-11-14>14</a>
</span><span class=lnt id=hl-11-15><a class=lnlinks href=#hl-11-15>15</a>
</span><span class=lnt id=hl-11-16><a class=lnlinks href=#hl-11-16>16</a>
</span><span class=lnt id=hl-11-17><a class=lnlinks href=#hl-11-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>## 报错的代码</span>
</span></span><span class=line><span class=cl><span class=c1>## models.py</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>NewsTag</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>news</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>ForeignKey</span><span class=p>(</span><span class=n>News</span><span class=p>,</span> <span class=n>on_delete</span><span class=o>=</span><span class=n>models</span><span class=o>.</span><span class=n>CASCADE</span><span class=p>,</span> <span class=n>db_column</span><span class=o>=</span><span class=s1>&#39;news_id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>tag</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>ForeignKey</span><span class=p>(</span><span class=n>Tag</span><span class=p>,</span> <span class=n>on_delete</span><span class=o>=</span><span class=n>models</span><span class=o>.</span><span class=n>CASCADE</span><span class=p>,</span> <span class=n>db_column</span><span class=o>=</span><span class=s1>&#39;tag_id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>Meta</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>db_table</span> <span class=o>=</span> <span class=s1>&#39;news_tag&#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>unique_together</span> <span class=o>=</span> <span class=p>((</span><span class=s1>&#39;news&#39;</span><span class=p>,</span> <span class=s1>&#39;tag&#39;</span><span class=p>),</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## serializers.py</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>NewsSerializer</span><span class=p>(</span><span class=n>serializers</span><span class=o>.</span><span class=n>ModelSerializer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>tags</span> <span class=o>=</span> <span class=n>TagSerializer</span><span class=p>(</span><span class=n>source</span><span class=o>=</span><span class=s1>&#39;newstag_set&#39;</span><span class=p>,</span> <span class=n>many</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>read_only</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>Meta</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span> <span class=o>=</span> <span class=n>News</span>
</span></span><span class=line><span class=cl>        <span class=n>fields</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>,</span> <span class=s1>&#39;title&#39;</span><span class=p>,</span> <span class=s1>&#39;body&#39;</span><span class=p>,</span> <span class=s1>&#39;pub_time&#39;</span><span class=p>,</span> <span class=s1>&#39;website&#39;</span><span class=p>,</span> <span class=s1>&#39;url&#39;</span><span class=p>,</span> <span class=s1>&#39;images&#39;</span><span class=p>,</span> <span class=s1>&#39;tags&#39;</span><span class=p>]</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><em>来分析一波</em></p><p>tags = TagSerializer(&mldr;) 背后的机制为</p><p>首先news.newstag_set.all() ## 获取该新闻对应的所有 NewsTag 对象</p><p>然后通过 TagSerializer 提取每个 NewsTag 对象中的 .tag 字段进行序列化。</p><p>也就是说，它会<strong>访问 news_tag 表中的记录，默认情况下会加载所有字段</strong>（包括 id），即使你没用到它。</p></blockquote><blockquote><p><em>教训</em></p><p>尽可能从后端建表，不然就会出现很多这样那样的问题</p></blockquote><p>潜在问题：</p><p>如果从后端在news_tag中创建新的数据，可能会再次报错。不过由于目前新闻分类的操作由独立的python脚本完成，因此暂时可以睁一只眼闭一只眼。</p><h3 id=标签列表>标签列表
<a class=header-anchor href=#%e6%a0%87%e7%ad%be%e5%88%97%e8%a1%a8></a></h3><p>很简单，只要返回tag表中的所有对象（为了方便先序列化）即可</p><h2 id=兴趣推送>兴趣推送
<a class=header-anchor href=#%e5%85%b4%e8%b6%a3%e6%8e%a8%e9%80%81></a></h2><h3 id=实现过程>实现过程
<a class=header-anchor href=#%e5%ae%9e%e7%8e%b0%e8%bf%87%e7%a8%8b></a></h3><p>明确实现步骤</p><ul><li>每天在 feedtime 为每个用户推送新发布的新闻。</li><li>推送内容根据用户的兴趣标签过滤。</li><li>使用 Celery 定时任务 + Redis。</li><li>使用增强版 FeedLog 记录每条新闻的推送记录。</li></ul><p>首先在用户模块添加<code>用户兴趣设置</code>和<code>获取用户兴趣</code>模块。目前仅基于分类标签（为简化，暂时不考虑实体）</p><p>由于推送功能相对独立，为方便管理，新建一个app</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>python</span> <span class=n>manage</span><span class=o>.</span><span class=n>py</span> <span class=n>startapp</span> <span class=n>feed</span></span></span></code></pre></td></tr></table></div></div><p>老操作，配置setting和路由</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a class=lnlinks href=#hl-13-1> 1</a>
</span><span class=lnt id=hl-13-2><a class=lnlinks href=#hl-13-2> 2</a>
</span><span class=lnt id=hl-13-3><a class=lnlinks href=#hl-13-3> 3</a>
</span><span class=lnt id=hl-13-4><a class=lnlinks href=#hl-13-4> 4</a>
</span><span class=lnt id=hl-13-5><a class=lnlinks href=#hl-13-5> 5</a>
</span><span class=lnt id=hl-13-6><a class=lnlinks href=#hl-13-6> 6</a>
</span><span class=lnt id=hl-13-7><a class=lnlinks href=#hl-13-7> 7</a>
</span><span class=lnt id=hl-13-8><a class=lnlinks href=#hl-13-8> 8</a>
</span><span class=lnt id=hl-13-9><a class=lnlinks href=#hl-13-9> 9</a>
</span><span class=lnt id=hl-13-10><a class=lnlinks href=#hl-13-10>10</a>
</span><span class=lnt id=hl-13-11><a class=lnlinks href=#hl-13-11>11</a>
</span><span class=lnt id=hl-13-12><a class=lnlinks href=#hl-13-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>## nrsmAPI_project/settings.py</span>
</span></span><span class=line><span class=cl><span class=n>INSTALLED_APPS</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;feed.apps.FeedConfig&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## nrsmAPI_project/urls.py</span>
</span></span><span class=line><span class=cl><span class=n>urlpatterns</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;feed/&#39;</span><span class=p>,</span> <span class=n>include</span><span class=p>(</span><span class=s1>&#39;feed.urls&#39;</span><span class=p>)),</span> <span class=c1>##  推送模块</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1>1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2>2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3>3</a>
</span><span class=lnt id=hl-14-4><a class=lnlinks href=#hl-14-4>4</a>
</span><span class=lnt id=hl-14-5><a class=lnlinks href=#hl-14-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## 安装实现定时任务的依赖</span>
</span></span><span class=line><span class=cl>pip install celery redis
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 安装管理定时任务的依赖</span>
</span></span><span class=line><span class=cl>pip install django-celery-beat</span></span></code></pre></td></tr></table></div></div><blockquote><p>注意：用户可以不选择设置兴趣标签，则系统不会推送。但是在SRS里好像写的是必须选择三个以上的标签（尬）。总之，后端对无标签的情况是有处理的。比如可能后面用户自己去主页取消了兴趣勾选。</p></blockquote><h3 id=迁移数据库>迁移数据库
<a class=header-anchor href=#%e8%bf%81%e7%a7%bb%e6%95%b0%e6%8d%ae%e5%ba%93></a></h3><p>由于需要插入一些测试数据，为了避免把服务器上的数据库搞乱，考虑将数据库备份到本机上</p><h4 id=使用命令行失败>使用命令行（失败）
<a class=header-anchor href=#%e4%bd%bf%e7%94%a8%e5%91%bd%e4%bb%a4%e8%a1%8c%e5%a4%b1%e8%b4%a5></a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-15-1><a class=lnlinks href=#hl-15-1> 1</a>
</span><span class=lnt id=hl-15-2><a class=lnlinks href=#hl-15-2> 2</a>
</span><span class=lnt id=hl-15-3><a class=lnlinks href=#hl-15-3> 3</a>
</span><span class=lnt id=hl-15-4><a class=lnlinks href=#hl-15-4> 4</a>
</span><span class=lnt id=hl-15-5><a class=lnlinks href=#hl-15-5> 5</a>
</span><span class=lnt id=hl-15-6><a class=lnlinks href=#hl-15-6> 6</a>
</span><span class=lnt id=hl-15-7><a class=lnlinks href=#hl-15-7> 7</a>
</span><span class=lnt id=hl-15-8><a class=lnlinks href=#hl-15-8> 8</a>
</span><span class=lnt id=hl-15-9><a class=lnlinks href=#hl-15-9> 9</a>
</span><span class=lnt id=hl-15-10><a class=lnlinks href=#hl-15-10>10</a>
</span><span class=lnt id=hl-15-11><a class=lnlinks href=#hl-15-11>11</a>
</span><span class=lnt id=hl-15-12><a class=lnlinks href=#hl-15-12>12</a>
</span><span class=lnt id=hl-15-13><a class=lnlinks href=#hl-15-13>13</a>
</span><span class=lnt id=hl-15-14><a class=lnlinks href=#hl-15-14>14</a>
</span><span class=lnt id=hl-15-15><a class=lnlinks href=#hl-15-15>15</a>
</span><span class=lnt id=hl-15-16><a class=lnlinks href=#hl-15-16>16</a>
</span><span class=lnt id=hl-15-17><a class=lnlinks href=#hl-15-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## 导出数据库</span>
</span></span><span class=line><span class=cl>mysqldump -h 192.168.207.77 -u root -p nrsm &gt; nrsm_backup.sql
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 输入密码</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 在本地</span>
</span></span><span class=line><span class=cl><span class=c1>## 创建备份数据库</span>
</span></span><span class=line><span class=cl>create database nrsm<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 查看数据库是否创建成功</span>
</span></span><span class=line><span class=cl>show database<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 切换到备份数据库</span>
</span></span><span class=line><span class=cl>use nrsm<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 使用source命令导入SQL文件（根目录为当前mysql命令窗口所在的目录）</span>
</span></span><span class=line><span class=cl><span class=nb>source</span> nrsm_backup.sql<span class=p>;</span></span></span></code></pre></td></tr></table></div></div><p>出现问题，查看数据库发现仅由部分数据导入成功
<img src=/imgs/img-lazy-loading.gif data-src=image-5.png alt="alt text"></p><p>改为使用mysql命令</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a class=lnlinks href=#hl-16-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mysql -u root -p nrsm_tt &lt; nrsm_backup.sql</span></span></code></pre></td></tr></table></div></div><p>问题仍然存在
<img src=/imgs/img-lazy-loading.gif data-src=image-6.png alt="alt text"></p><h4 id=使用mysql-workbench成功>使用mysql workbench（成功）
<a class=header-anchor href=#%e4%bd%bf%e7%94%a8mysql-workbench%e6%88%90%e5%8a%9f></a></h4><p><strong>直接使用mysql workbench的Export和Import功能</strong></p><p>备份成功！</p><h3 id=邮件发送功能>邮件发送功能
<a class=header-anchor href=#%e9%82%ae%e4%bb%b6%e5%8f%91%e9%80%81%e5%8a%9f%e8%83%bd></a></h3><p>一上来就搞“定时 + 邮件 + 兴趣过滤”不好测试（主要是对其中的流程不熟，一旦出错难以定位问题），因此决定先实现邮件推送功能。</p><p>使用的邮箱为163（QQ也可以）</p><blockquote><p>参考博客：</p><ul><li><a href=https://blog.csdn.net/KaiSarH/article/details/116724290 title=https://blog.csdn.net/KaiSarH/article/details/116724290 rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://blog.csdn.net/KaiSarH/article/details/116724290
<i class="fa fa-external-link-alt"></i></a></li><li><a href=https://blog.csdn.net/weixin_42677653/article/details/114535724 title=https://blog.csdn.net/weixin_42677653/article/details/114535724 rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://blog.csdn.net/weixin_42677653/article/details/114535724
<i class="fa fa-external-link-alt"></i></a></li></ul></blockquote><p><img src=/imgs/img-lazy-loading.gif data-src=image-8.png alt="alt text"></p><p>Django邮件功能主要基于SMTP协议。基本原理为</p><ul><li>授权邮箱给Django</li><li>向对应收件人发送邮件</li><li>django.core.mail封装了电子邮件的自动发送SMTP协议</li></ul><h4 id=开通smtp服务>开通SMTP服务
<a class=header-anchor href=#%e5%bc%80%e9%80%9asmtp%e6%9c%8d%e5%8a%a1></a></h4><p><img src=/imgs/img-lazy-loading.gif data-src=image-9.png alt="alt text"></p><p><img src=/imgs/img-lazy-loading.gif data-src=image-10.png alt="alt text"></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-17-1><a class=lnlinks href=#hl-17-1> 1</a>
</span><span class=lnt id=hl-17-2><a class=lnlinks href=#hl-17-2> 2</a>
</span><span class=lnt id=hl-17-3><a class=lnlinks href=#hl-17-3> 3</a>
</span><span class=lnt id=hl-17-4><a class=lnlinks href=#hl-17-4> 4</a>
</span><span class=lnt id=hl-17-5><a class=lnlinks href=#hl-17-5> 5</a>
</span><span class=lnt id=hl-17-6><a class=lnlinks href=#hl-17-6> 6</a>
</span><span class=lnt id=hl-17-7><a class=lnlinks href=#hl-17-7> 7</a>
</span><span class=lnt id=hl-17-8><a class=lnlinks href=#hl-17-8> 8</a>
</span><span class=lnt id=hl-17-9><a class=lnlinks href=#hl-17-9> 9</a>
</span><span class=lnt id=hl-17-10><a class=lnlinks href=#hl-17-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>## settings.py</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 邮件配置</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_BACKEND</span> <span class=o>=</span> <span class=s1>&#39;django.core.mail.backends.smtp.EmailBackend&#39;</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_USE_TLS</span> <span class=o>=</span> <span class=kc>True</span>  <span class=c1>## 是否使用TLS安全传输协议(用于在两个通信应用程序之间提供保密性和数据完整性)</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_USE_SSL</span> <span class=o>=</span> <span class=kc>False</span>  <span class=c1>## 是否使用SSL加密，qq企业邮箱要求使用，163邮箱设置为True的时候会报ssl的错误</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_HOST</span> <span class=o>=</span> <span class=s1>&#39;smtp.163.com&#39;</span>  <span class=c1>## 发送邮件的邮箱的SMTP服务器，这里用的是163邮箱</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_PORT</span> <span class=o>=</span> <span class=mi>25</span>  <span class=c1>## 发件箱的SMTP服务器端口，默认是25</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_HOST_USER</span> <span class=o>=</span> <span class=s1>&#39;test@163.com&#39;</span>  <span class=c1>## 发送邮件的邮箱地址</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_HOST_PASSWORD</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s1>&#39;EMAIL_HOST_PASSWORD&#39;</span><span class=p>)</span> <span class=c1>## 发送邮件的邮箱密码(这里使用的是授权码)</span></span></span></code></pre></td></tr></table></div></div><h4 id=邮件发送测试>邮件发送测试
<a class=header-anchor href=#%e9%82%ae%e4%bb%b6%e5%8f%91%e9%80%81%e6%b5%8b%e8%af%95></a></h4><p>通过view测试。这里用了自己的163发送给自己的qq邮箱</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-18-1><a class=lnlinks href=#hl-18-1> 1</a>
</span><span class=lnt id=hl-18-2><a class=lnlinks href=#hl-18-2> 2</a>
</span><span class=lnt id=hl-18-3><a class=lnlinks href=#hl-18-3> 3</a>
</span><span class=lnt id=hl-18-4><a class=lnlinks href=#hl-18-4> 4</a>
</span><span class=lnt id=hl-18-5><a class=lnlinks href=#hl-18-5> 5</a>
</span><span class=lnt id=hl-18-6><a class=lnlinks href=#hl-18-6> 6</a>
</span><span class=lnt id=hl-18-7><a class=lnlinks href=#hl-18-7> 7</a>
</span><span class=lnt id=hl-18-8><a class=lnlinks href=#hl-18-8> 8</a>
</span><span class=lnt id=hl-18-9><a class=lnlinks href=#hl-18-9> 9</a>
</span><span class=lnt id=hl-18-10><a class=lnlinks href=#hl-18-10>10</a>
</span><span class=lnt id=hl-18-11><a class=lnlinks href=#hl-18-11>11</a>
</span><span class=lnt id=hl-18-12><a class=lnlinks href=#hl-18-12>12</a>
</span><span class=lnt id=hl-18-13><a class=lnlinks href=#hl-18-13>13</a>
</span><span class=lnt id=hl-18-14><a class=lnlinks href=#hl-18-14>14</a>
</span><span class=lnt id=hl-18-15><a class=lnlinks href=#hl-18-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>## feed/utils.py</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>django.core.mail</span> <span class=kn>import</span> <span class=n>send_mail</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dotenv</span> <span class=kn>import</span> <span class=n>load_dotenv</span>
</span></span><span class=line><span class=cl><span class=n>load_dotenv</span><span class=p>()</span> <span class=c1>## 加载 .env 文件</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_mail_test</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;开始发送邮件...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>send_mail</span><span class=p>(</span><span class=s1>&#39;邮件主题&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=s1>&#39;邮件内容&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;EMAIL_HOST_USER&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>              <span class=p>[</span><span class=s1>&#39;test_1@domain.com&#39;</span><span class=p>,</span> <span class=s1>&#39;test_2@domain.com&#39;</span><span class=p>],</span>  <span class=c1>## 这里可以同时发给多个收件人</span>
</span></span><span class=line><span class=cl>              <span class=n>fail_silently</span><span class=o>=</span><span class=kc>False</span>
</span></span><span class=line><span class=cl>             <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;发送邮件成功!&#34;</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-19-1><a class=lnlinks href=#hl-19-1>1</a>
</span><span class=lnt id=hl-19-2><a class=lnlinks href=#hl-19-2>2</a>
</span><span class=lnt id=hl-19-3><a class=lnlinks href=#hl-19-3>3</a>
</span><span class=lnt id=hl-19-4><a class=lnlinks href=#hl-19-4>4</a>
</span><span class=lnt id=hl-19-5><a class=lnlinks href=#hl-19-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>## feed/views.py</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EmailTestView</span><span class=p>(</span><span class=n>APIView</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>send_mail_test</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>JsonResponse</span><span class=p>({</span><span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=mi>200</span><span class=p>,</span> <span class=s2>&#34;info&#34;</span><span class=p>:</span> <span class=s2>&#34;邮件发送成功&#34;</span><span class=p>})</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-20-1><a class=lnlinks href=#hl-20-1>1</a>
</span><span class=lnt id=hl-20-2><a class=lnlinks href=#hl-20-2>2</a>
</span><span class=lnt id=hl-20-3><a class=lnlinks href=#hl-20-3>3</a>
</span><span class=lnt id=hl-20-4><a class=lnlinks href=#hl-20-4>4</a>
</span><span class=lnt id=hl-20-5><a class=lnlinks href=#hl-20-5>5</a>
</span><span class=lnt id=hl-20-6><a class=lnlinks href=#hl-20-6>6</a>
</span><span class=lnt id=hl-20-7><a class=lnlinks href=#hl-20-7>7</a>
</span><span class=lnt id=hl-20-8><a class=lnlinks href=#hl-20-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>## feed/urls.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>path</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>feed.views</span> <span class=kn>import</span> <span class=n>EmailTestView</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>urlpatterns</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;email_test/&#39;</span><span class=p>,</span> <span class=n>EmailTestView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;email-test&#39;</span><span class=p>),</span> <span class=c1>## 邮件发送测试</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></td></tr></table></div></div><p>postman测试</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-21-1><a class=lnlinks href=#hl-21-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>http://127.0.0.1:8000/feed/email_test/</span></span></code></pre></td></tr></table></div></div><p><img src=/imgs/img-lazy-loading.gif data-src=image-11.png alt="alt text"></p><p><img src=/imgs/img-lazy-loading.gif data-src=image-12.png alt="alt text"></p><blockquote><p>错误：SMTPAuthenticationError</p><p>原因是身份验证错误，检查一下settings.py中的邮箱配置是否正确，尤其注意EMAIL_HOST_PASSWORD，是开启服务时给你的授权码，不是平时的登录密码！！！不是平时的登录密码！！！不是平时的登录密码！！！</p></blockquote><h3 id=定时邮件发送django-background-tasks-失败>定时邮件发送（django-background-tasks 失败）
<a class=header-anchor href=#%e5%ae%9a%e6%97%b6%e9%82%ae%e4%bb%b6%e5%8f%91%e9%80%81django-background-tasks-%e5%a4%b1%e8%b4%a5></a></h3><blockquote><p>参考博客：
<a href=https://deepinout.com/django/django-questions/271_django_how_to_use_djangobackgroundtasks.html title=https://deepinout.com/django/django-questions/271_django_how_to_use_djangobackgroundtasks.html rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://deepinout.com/django/django-questions/271_django_how_to_use_djangobackgroundtasks.html
<i class="fa fa-external-link-alt"></i></a></p></blockquote><p>使用Django自带的插件django-background-tasks</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-22-1><a class=lnlinks href=#hl-22-1>1</a>
</span><span class=lnt id=hl-22-2><a class=lnlinks href=#hl-22-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 安装django-background-tasks插件</span>
</span></span><span class=line><span class=cl>pip install django-background-tasks</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-23-1><a class=lnlinks href=#hl-23-1>1</a>
</span><span class=lnt id=hl-23-2><a class=lnlinks href=#hl-23-2>2</a>
</span><span class=lnt id=hl-23-3><a class=lnlinks href=#hl-23-3>3</a>
</span><span class=lnt id=hl-23-4><a class=lnlinks href=#hl-23-4>4</a>
</span><span class=lnt id=hl-23-5><a class=lnlinks href=#hl-23-5>5</a>
</span><span class=lnt id=hl-23-6><a class=lnlinks href=#hl-23-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># settings.py</span>
</span></span><span class=line><span class=cl><span class=n>INSTALLED_APPS</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1># 后台任务</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;background_task&#39;</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-24-1><a class=lnlinks href=#hl-24-1>1</a>
</span><span class=lnt id=hl-24-2><a class=lnlinks href=#hl-24-2>2</a>
</span><span class=lnt id=hl-24-3><a class=lnlinks href=#hl-24-3>3</a>
</span><span class=lnt id=hl-24-4><a class=lnlinks href=#hl-24-4>4</a>
</span><span class=lnt id=hl-24-5><a class=lnlinks href=#hl-24-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 生成 background_task 的迁移文件（可选）</span>
</span></span><span class=line><span class=cl>python manage.py makemigrations background_task
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 应用 migration，只创建 background_task 表</span>
</span></span><span class=line><span class=cl>python manage.py migrate background_task</span></span></code></pre></td></tr></table></div></div><blockquote><p>错误：RuntimeError: &lsquo;cryptography&rsquo; package is required for sha256_password or caching_sha2_password auth methods</p><p>在使用 MySQL 数据库时，尝试通过 sha256_password 或 caching_sha2_password 认证方式连接数据库，但 Python 的数据库驱动（通常是 mysqlclient 或 pymysql）缺少支持这些认证方式所需的 cryptography 库。</p><p>安装 cryptography 库即可 <code>pip install cryptography</code></p></blockquote><p>在 <code>feed/tasks.py</code> 中创建一个后台任务</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-25-1><a class=lnlinks href=#hl-25-1> 1</a>
</span><span class=lnt id=hl-25-2><a class=lnlinks href=#hl-25-2> 2</a>
</span><span class=lnt id=hl-25-3><a class=lnlinks href=#hl-25-3> 3</a>
</span><span class=lnt id=hl-25-4><a class=lnlinks href=#hl-25-4> 4</a>
</span><span class=lnt id=hl-25-5><a class=lnlinks href=#hl-25-5> 5</a>
</span><span class=lnt id=hl-25-6><a class=lnlinks href=#hl-25-6> 6</a>
</span><span class=lnt id=hl-25-7><a class=lnlinks href=#hl-25-7> 7</a>
</span><span class=lnt id=hl-25-8><a class=lnlinks href=#hl-25-8> 8</a>
</span><span class=lnt id=hl-25-9><a class=lnlinks href=#hl-25-9> 9</a>
</span><span class=lnt id=hl-25-10><a class=lnlinks href=#hl-25-10>10</a>
</span><span class=lnt id=hl-25-11><a class=lnlinks href=#hl-25-11>11</a>
</span><span class=lnt id=hl-25-12><a class=lnlinks href=#hl-25-12>12</a>
</span><span class=lnt id=hl-25-13><a class=lnlinks href=#hl-25-13>13</a>
</span><span class=lnt id=hl-25-14><a class=lnlinks href=#hl-25-14>14</a>
</span><span class=lnt id=hl-25-15><a class=lnlinks href=#hl-25-15>15</a>
</span><span class=lnt id=hl-25-16><a class=lnlinks href=#hl-25-16>16</a>
</span><span class=lnt id=hl-25-17><a class=lnlinks href=#hl-25-17>17</a>
</span><span class=lnt id=hl-25-18><a class=lnlinks href=#hl-25-18>18</a>
</span><span class=lnt id=hl-25-19><a class=lnlinks href=#hl-25-19>19</a>
</span><span class=lnt id=hl-25-20><a class=lnlinks href=#hl-25-20>20</a>
</span><span class=lnt id=hl-25-21><a class=lnlinks href=#hl-25-21>21</a>
</span><span class=lnt id=hl-25-22><a class=lnlinks href=#hl-25-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># feed/tasks.py</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dotenv</span> <span class=kn>import</span> <span class=n>load_dotenv</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>django.core.mail</span> <span class=kn>import</span> <span class=n>send_mail</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>background_task</span> <span class=kn>import</span> <span class=n>background</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>load_dotenv</span><span class=p>()</span> <span class=c1># 加载 .env 文件</span>
</span></span><span class=line><span class=cl><span class=nd>@background</span><span class=p>(</span><span class=n>schedule</span><span class=o>=</span><span class=mi>60</span><span class=p>)</span>  <span class=c1># 每60秒运行一次</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_email_task</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    定时发送邮件任务
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;开始执行定时邮件发送任务...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>send_mail</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;Hello&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;This is a background task to send an email.&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;EMAIL_HOST_USER&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=s1>&#39;to@domain.com&#39;</span><span class=p>],</span>  <span class=c1># 这里可以同时发给多个收件人</span>
</span></span><span class=line><span class=cl>        <span class=n>fail_silently</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>在 <code>feed/views.py</code> 中设置调用任务的接口</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-26-1><a class=lnlinks href=#hl-26-1>1</a>
</span><span class=lnt id=hl-26-2><a class=lnlinks href=#hl-26-2>2</a>
</span><span class=lnt id=hl-26-3><a class=lnlinks href=#hl-26-3>3</a>
</span><span class=lnt id=hl-26-4><a class=lnlinks href=#hl-26-4>4</a>
</span><span class=lnt id=hl-26-5><a class=lnlinks href=#hl-26-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># feed/views.py</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BackTaskView</span><span class=p>(</span><span class=n>APIView</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>send_email_task</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>JsonResponse</span><span class=p>({</span><span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=mi>200</span><span class=p>,</span> <span class=s2>&#34;info&#34;</span><span class=p>:</span> <span class=s2>&#34;后台任务执行成功&#34;</span><span class=p>})</span></span></span></code></pre></td></tr></table></div></div><p>在 <code>feed/urls.py</code> 中配置路由</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-27-1><a class=lnlinks href=#hl-27-1>1</a>
</span><span class=lnt id=hl-27-2><a class=lnlinks href=#hl-27-2>2</a>
</span><span class=lnt id=hl-27-3><a class=lnlinks href=#hl-27-3>3</a>
</span><span class=lnt id=hl-27-4><a class=lnlinks href=#hl-27-4>4</a>
</span><span class=lnt id=hl-27-5><a class=lnlinks href=#hl-27-5>5</a>
</span><span class=lnt id=hl-27-6><a class=lnlinks href=#hl-27-6>6</a>
</span><span class=lnt id=hl-27-7><a class=lnlinks href=#hl-27-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>path</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>feed.views</span> <span class=kn>import</span> <span class=n>FeedHistoryView</span><span class=p>,</span> <span class=n>EmailTestView</span><span class=p>,</span> <span class=n>BackTaskView</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>urlpatterns</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;back_task/&#39;</span><span class=p>,</span> <span class=n>BackTaskView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;back-task&#39;</span><span class=p>)</span> <span class=c1># 后台任务</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></td></tr></table></div></div><p>在终端运行任务</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-28-1><a class=lnlinks href=#hl-28-1>1</a>
</span><span class=lnt id=hl-28-2><a class=lnlinks href=#hl-28-2>2</a>
</span><span class=lnt id=hl-28-3><a class=lnlinks href=#hl-28-3>3</a>
</span><span class=lnt id=hl-28-4><a class=lnlinks href=#hl-28-4>4</a>
</span><span class=lnt id=hl-28-5><a class=lnlinks href=#hl-28-5>5</a>
</span><span class=lnt id=hl-28-6><a class=lnlinks href=#hl-28-6>6</a>
</span><span class=lnt id=hl-28-7><a class=lnlinks href=#hl-28-7>7</a>
</span><span class=lnt id=hl-28-8><a class=lnlinks href=#hl-28-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python manage.py runserver
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 再打开一个终端</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>--duration=0 表示无限运行。
</span></span></span><span class=line><span class=cl><span class=s2>--sleep=5 表示每 5 秒检查一次是否有新任务。
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>python manage.py process_tasks --duration<span class=o>=</span><span class=m>0</span> --sleep<span class=o>=</span><span class=m>5</span></span></span></code></pre></td></tr></table></div></div><p>发现只有在请求服务时会建立后台任务，无法实现按照设定的频率进行</p><p>解决方案</p><ol><li>伪周期调度<ol><li>在方法内自己调度自己</li><li>然而实测出现创建任务的没有严格按照所设定的间隔，导致一次发送多封邮件，可能和时间同步有关系</li></ol></li><li>使用 Celery + Celery Beat √<ol><li>Celery：异步任务队列</li><li>Celery Beat：周期性任务调度器</li></ol></li></ol><h3 id=定时邮件发送celery--celery-beat>定时邮件发送（Celery + Celery Beat）
<a class=header-anchor href=#%e5%ae%9a%e6%97%b6%e9%82%ae%e4%bb%b6%e5%8f%91%e9%80%81celery--celery-beat></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-29-1><a class=lnlinks href=#hl-29-1>1</a>
</span><span class=lnt id=hl-29-2><a class=lnlinks href=#hl-29-2>2</a>
</span><span class=lnt id=hl-29-3><a class=lnlinks href=#hl-29-3>3</a>
</span><span class=lnt id=hl-29-4><a class=lnlinks href=#hl-29-4>4</a>
</span><span class=lnt id=hl-29-5><a class=lnlinks href=#hl-29-5>5</a>
</span><span class=lnt id=hl-29-6><a class=lnlinks href=#hl-29-6>6</a>
</span><span class=lnt id=hl-29-7><a class=lnlinks href=#hl-29-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pip install celery django-celery-beat redis
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 生成 django-celery-beat 的迁移文件</span>
</span></span><span class=line><span class=cl>python manage.py makemigrations django_celery_beat
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 应用 migration，只创建 django-celery-beat 表</span>
</span></span><span class=line><span class=cl>python manage.py migrate django_celery_beat</span></span></code></pre></td></tr></table></div></div><p>配置celery</p><blockquote><p>参考博客：
<a href=https://developer.aliyun.com/article/1582419 title=https://developer.aliyun.com/article/1582419 rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://developer.aliyun.com/article/1582419
<i class="fa fa-external-link-alt"></i></a></p></blockquote><p>下载Redis（Windows）</p><blockquote><p>参考博客：https://developer.aliyun.com/article/1395346</p></blockquote><p>完成后，执行以下步骤</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-30-1><a class=lnlinks href=#hl-30-1> 1</a>
</span><span class=lnt id=hl-30-2><a class=lnlinks href=#hl-30-2> 2</a>
</span><span class=lnt id=hl-30-3><a class=lnlinks href=#hl-30-3> 3</a>
</span><span class=lnt id=hl-30-4><a class=lnlinks href=#hl-30-4> 4</a>
</span><span class=lnt id=hl-30-5><a class=lnlinks href=#hl-30-5> 5</a>
</span><span class=lnt id=hl-30-6><a class=lnlinks href=#hl-30-6> 6</a>
</span><span class=lnt id=hl-30-7><a class=lnlinks href=#hl-30-7> 7</a>
</span><span class=lnt id=hl-30-8><a class=lnlinks href=#hl-30-8> 8</a>
</span><span class=lnt id=hl-30-9><a class=lnlinks href=#hl-30-9> 9</a>
</span><span class=lnt id=hl-30-10><a class=lnlinks href=#hl-30-10>10</a>
</span><span class=lnt id=hl-30-11><a class=lnlinks href=#hl-30-11>11</a>
</span><span class=lnt id=hl-30-12><a class=lnlinks href=#hl-30-12>12</a>
</span><span class=lnt id=hl-30-13><a class=lnlinks href=#hl-30-13>13</a>
</span><span class=lnt id=hl-30-14><a class=lnlinks href=#hl-30-14>14</a>
</span><span class=lnt id=hl-30-15><a class=lnlinks href=#hl-30-15>15</a>
</span><span class=lnt id=hl-30-16><a class=lnlinks href=#hl-30-16>16</a>
</span><span class=lnt id=hl-30-17><a class=lnlinks href=#hl-30-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># 启动 Redis
</span></span><span class=line><span class=cl>redis-server.exe redis.windows.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 在项目终端进行 Redis 连接测试
</span></span><span class=line><span class=cl>redis-cli ping
</span></span><span class=line><span class=cl># 如有跟着博客配置密码
</span></span><span class=line><span class=cl>redis-cli -a your_password ping
</span></span><span class=line><span class=cl># 返回 PONG 即说明Redis成功运行
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 启动 Django 开发服务器
</span></span><span class=line><span class=cl>python manage.py runserver
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 启动 Celery Worker
</span></span><span class=line><span class=cl>celery -A nrsmAPI_project worker --loglevel=info
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 启动 Celery Beat
</span></span><span class=line><span class=cl>celery -A nrsmAPI_project beat --loglevel=info</span></span></code></pre></td></tr></table></div></div><blockquote><p>错误：(venv) D:\administrator\College\课后笔记\News-recommendation-system\e2\newsAPI_project>redis-cli ping
(error) NOAUTH Authentication required.</p><p>在 redis.windows.conf 文件中配置了密码，但是在终端执行命令时未提供。加上 -a your_passoword 即可。</p></blockquote><blockquote><p>如果修改了 redis.windows.conf 后，需要重新启动 Redis 才会生效
（很简单的道理，但总是容易忘记囧）</p></blockquote><blockquote><p>检查 Celery Worker，celery -A nrsmAPI_project worker &ndash;loglevel=info 的启动日志，发现没有加载任何任务</p><p><img src=/imgs/img-lazy-loading.gif data-src=image-13.png alt="alt text"></p><p>在 feed/apps.py 中强制导入 import feed.tasks 即可</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-31-1><a class=lnlinks href=#hl-31-1>1</a>
</span><span class=lnt id=hl-31-2><a class=lnlinks href=#hl-31-2>2</a>
</span><span class=lnt id=hl-31-3><a class=lnlinks href=#hl-31-3>3</a>
</span><span class=lnt id=hl-31-4><a class=lnlinks href=#hl-31-4>4</a>
</span><span class=lnt id=hl-31-5><a class=lnlinks href=#hl-31-5>5</a>
</span><span class=lnt id=hl-31-6><a class=lnlinks href=#hl-31-6>6</a>
</span><span class=lnt id=hl-31-7><a class=lnlinks href=#hl-31-7>7</a>
</span><span class=lnt id=hl-31-8><a class=lnlinks href=#hl-31-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>The above exception was the direct cause of the following exception:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Traceback (most recent call last):
</span></span><span class=line><span class=cl>  File &#34;c:\users\fshjp\appdata\local\programs\python\python39\lib\site-packages\billiard\pool.py&#34;, line 362, in workloop
</span></span><span class=line><span class=cl>    result = (True, prepare_result(fun(*args, **kwargs)))
</span></span><span class=line><span class=cl>  File &#34;c:\users\fshjp\appdata\local\programs\python\python39\lib\site-packages\celery\app\trace.py&#34;, line 640, in fast_trace_task
</span></span><span class=line><span class=cl>    tasks, accept, hostname = _loc
</span></span><span class=line><span class=cl>ValueError: not enough values to unpack (expected 3, got 0)</span></span></code></pre></td></tr></table></div></div><p>在win10上运行celery4.x，celery5.x会出现此问题</p><blockquote><p>参考博客：
<a href=https://blog.csdn.net/showgea/article/details/109342664 title=https://blog.csdn.net/showgea/article/details/109342664 rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://blog.csdn.net/showgea/article/details/109342664
<i class="fa fa-external-link-alt"></i></a></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-32-1><a class=lnlinks href=#hl-32-1>1</a>
</span><span class=lnt id=hl-32-2><a class=lnlinks href=#hl-32-2>2</a>
</span><span class=lnt id=hl-32-3><a class=lnlinks href=#hl-32-3>3</a>
</span><span class=lnt id=hl-32-4><a class=lnlinks href=#hl-32-4>4</a>
</span><span class=lnt id=hl-32-5><a class=lnlinks href=#hl-32-5>5</a>
</span><span class=lnt id=hl-32-6><a class=lnlinks href=#hl-32-6>6</a>
</span><span class=lnt id=hl-32-7><a class=lnlinks href=#hl-32-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pip install eventlet
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加参数 -P </span>
</span></span><span class=line><span class=cl>celery -A nrsmAPI_project worker -l info -P eventlet
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 再启动 Celery Beat</span>
</span></span><span class=line><span class=cl>celery -A nrsmAPI_project beat --loglevel<span class=o>=</span>info</span></span></code></pre></td></tr></table></div></div><p>时间间隔为 20s ，实测差不多 +- 1s</p><p><img src=/imgs/img-lazy-loading.gif data-src=image-14.png alt="alt text"></p><h3 id=根据用户兴趣和时段推送新闻>根据用户兴趣和时段推送新闻
<a class=header-anchor href=#%e6%a0%b9%e6%8d%ae%e7%94%a8%e6%88%b7%e5%85%b4%e8%b6%a3%e5%92%8c%e6%97%b6%e6%ae%b5%e6%8e%a8%e9%80%81%e6%96%b0%e9%97%bb></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-33-1><a class=lnlinks href=#hl-33-1> 1</a>
</span><span class=lnt id=hl-33-2><a class=lnlinks href=#hl-33-2> 2</a>
</span><span class=lnt id=hl-33-3><a class=lnlinks href=#hl-33-3> 3</a>
</span><span class=lnt id=hl-33-4><a class=lnlinks href=#hl-33-4> 4</a>
</span><span class=lnt id=hl-33-5><a class=lnlinks href=#hl-33-5> 5</a>
</span><span class=lnt id=hl-33-6><a class=lnlinks href=#hl-33-6> 6</a>
</span><span class=lnt id=hl-33-7><a class=lnlinks href=#hl-33-7> 7</a>
</span><span class=lnt id=hl-33-8><a class=lnlinks href=#hl-33-8> 8</a>
</span><span class=lnt id=hl-33-9><a class=lnlinks href=#hl-33-9> 9</a>
</span><span class=lnt id=hl-33-10><a class=lnlinks href=#hl-33-10>10</a>
</span><span class=lnt id=hl-33-11><a class=lnlinks href=#hl-33-11>11</a>
</span><span class=lnt id=hl-33-12><a class=lnlinks href=#hl-33-12>12</a>
</span><span class=lnt id=hl-33-13><a class=lnlinks href=#hl-33-13>13</a>
</span><span class=lnt id=hl-33-14><a class=lnlinks href=#hl-33-14>14</a>
</span><span class=lnt id=hl-33-15><a class=lnlinks href=#hl-33-15>15</a>
</span><span class=lnt id=hl-33-16><a class=lnlinks href=#hl-33-16>16</a>
</span><span class=lnt id=hl-33-17><a class=lnlinks href=#hl-33-17>17</a>
</span><span class=lnt id=hl-33-18><a class=lnlinks href=#hl-33-18>18</a>
</span><span class=lnt id=hl-33-19><a class=lnlinks href=#hl-33-19>19</a>
</span><span class=lnt id=hl-33-20><a class=lnlinks href=#hl-33-20>20</a>
</span><span class=lnt id=hl-33-21><a class=lnlinks href=#hl-33-21>21</a>
</span><span class=lnt id=hl-33-22><a class=lnlinks href=#hl-33-22>22</a>
</span><span class=lnt id=hl-33-23><a class=lnlinks href=#hl-33-23>23</a>
</span><span class=lnt id=hl-33-24><a class=lnlinks href=#hl-33-24>24</a>
</span><span class=lnt id=hl-33-25><a class=lnlinks href=#hl-33-25>25</a>
</span><span class=lnt id=hl-33-26><a class=lnlinks href=#hl-33-26>26</a>
</span><span class=lnt id=hl-33-27><a class=lnlinks href=#hl-33-27>27</a>
</span><span class=lnt id=hl-33-28><a class=lnlinks href=#hl-33-28>28</a>
</span><span class=lnt id=hl-33-29><a class=lnlinks href=#hl-33-29>29</a>
</span><span class=lnt id=hl-33-30><a class=lnlinks href=#hl-33-30>30</a>
</span><span class=lnt id=hl-33-31><a class=lnlinks href=#hl-33-31>31</a>
</span><span class=lnt id=hl-33-32><a class=lnlinks href=#hl-33-32>32</a>
</span><span class=lnt id=hl-33-33><a class=lnlinks href=#hl-33-33>33</a>
</span><span class=lnt id=hl-33-34><a class=lnlinks href=#hl-33-34>34</a>
</span><span class=lnt id=hl-33-35><a class=lnlinks href=#hl-33-35>35</a>
</span><span class=lnt id=hl-33-36><a class=lnlinks href=#hl-33-36>36</a>
</span><span class=lnt id=hl-33-37><a class=lnlinks href=#hl-33-37>37</a>
</span><span class=lnt id=hl-33-38><a class=lnlinks href=#hl-33-38>38</a>
</span><span class=lnt id=hl-33-39><a class=lnlinks href=#hl-33-39>39</a>
</span><span class=lnt id=hl-33-40><a class=lnlinks href=#hl-33-40>40</a>
</span><span class=lnt id=hl-33-41><a class=lnlinks href=#hl-33-41>41</a>
</span><span class=lnt id=hl-33-42><a class=lnlinks href=#hl-33-42>42</a>
</span><span class=lnt id=hl-33-43><a class=lnlinks href=#hl-33-43>43</a>
</span><span class=lnt id=hl-33-44><a class=lnlinks href=#hl-33-44>44</a>
</span><span class=lnt id=hl-33-45><a class=lnlinks href=#hl-33-45>45</a>
</span><span class=lnt id=hl-33-46><a class=lnlinks href=#hl-33-46>46</a>
</span><span class=lnt id=hl-33-47><a class=lnlinks href=#hl-33-47>47</a>
</span><span class=lnt id=hl-33-48><a class=lnlinks href=#hl-33-48>48</a>
</span><span class=lnt id=hl-33-49><a class=lnlinks href=#hl-33-49>49</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># settings.py</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=c1>#  Celery配置</span>
</span></span><span class=line><span class=cl><span class=n>CELERY_BROKER_URL</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s1>&#39;CELERY_BROKER_URL&#39;</span><span class=p>,</span> <span class=s1>&#39;redis://127.0.0.1:6379/0&#39;</span><span class=p>)</span> <span class=c1>#  使用Redis作为消息代理</span>
</span></span><span class=line><span class=cl><span class=n>CELERY_RESULT_BACKEND</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s1>&#39;CELERY_RESULT_BACKEND&#39;</span><span class=p>,</span> <span class=s1>&#39;redis://127.0.0.1:6379/0&#39;</span><span class=p>)</span> <span class=c1>#  使用Redis作为结果存储</span>
</span></span><span class=line><span class=cl><span class=n>CELERY_ACCEPT_CONTENT</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;json&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>CELERY_TASK_SERIALIZER</span> <span class=o>=</span> <span class=s1>&#39;json&#39;</span>
</span></span><span class=line><span class=cl><span class=n>CELERY_RESULT_SERIALIZER</span> <span class=o>=</span> <span class=s1>&#39;json&#39;</span>
</span></span><span class=line><span class=cl><span class=n>CELERY_TIMEZONE</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s1>&#39;TIMEZONE&#39;</span><span class=p>,</span> <span class=s1>&#39;UTC&#39;</span><span class=p>)</span> <span class=c1>#  北京时间</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Celery beat</span>
</span></span><span class=line><span class=cl><span class=n>CELERY_BEAT_SCHEDULER</span> <span class=o>=</span> <span class=s1>&#39;django_celery_beat.schedulers:DatabaseScheduler&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定时任务配置</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>celery.schedules</span> <span class=kn>import</span> <span class=n>crontab</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>CELERY_BEAT_SCHEDULE</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;check-user-feedtime-every-minute&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;task&#39;</span><span class=p>:</span> <span class=s1>&#39;feed.tasks.check_and_send_news_feed&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;schedule&#39;</span><span class=p>:</span> <span class=n>crontab</span><span class=p>(</span><span class=n>minute</span><span class=o>=</span><span class=s1>&#39;*&#39;</span><span class=p>),</span>  <span class=c1># 每分钟检查是否满足推送条件</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>LOGGING</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;version&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;disable_existing_loggers&#39;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;handlers&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;console&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;logging.StreamHandler&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;loggers&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;feed.tasks&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;handlers&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;console&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;level&#39;</span><span class=p>:</span> <span class=s1>&#39;INFO&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 邮件配置</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_BACKEND</span> <span class=o>=</span> <span class=s1>&#39;django.core.mail.backends.smtp.EmailBackend&#39;</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_USE_TLS</span> <span class=o>=</span> <span class=kc>True</span>  <span class=c1># 是否使用TLS安全传输协议(用于在两个通信应用程序之间提供保密性和数据完整性)</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_USE_SSL</span> <span class=o>=</span> <span class=kc>False</span>  <span class=c1># 是否使用SSL加密，qq企业邮箱要求使用，163邮箱设置为True的时候会报ssl的错误</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_HOST</span> <span class=o>=</span> <span class=s1>&#39;smtp.163.com&#39;</span>  <span class=c1># 发送邮件的邮箱的SMTP服务器，这里用的是163邮箱</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_PORT</span> <span class=o>=</span> <span class=mi>25</span>  <span class=c1># 发件箱的SMTP服务器端口，默认是25</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_HOST_USER</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;EMAIL_HOST_USER&#34;</span><span class=p>)</span>  <span class=c1># 发送邮件的邮箱地址</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_HOST_PASSWORD</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s1>&#39;EMAIL_HOST_PASSWORD&#39;</span><span class=p>)</span> <span class=c1># 发送邮件的邮箱密码(这里使用的是授权码)</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-34-1><a class=lnlinks href=#hl-34-1>  1</a>
</span><span class=lnt id=hl-34-2><a class=lnlinks href=#hl-34-2>  2</a>
</span><span class=lnt id=hl-34-3><a class=lnlinks href=#hl-34-3>  3</a>
</span><span class=lnt id=hl-34-4><a class=lnlinks href=#hl-34-4>  4</a>
</span><span class=lnt id=hl-34-5><a class=lnlinks href=#hl-34-5>  5</a>
</span><span class=lnt id=hl-34-6><a class=lnlinks href=#hl-34-6>  6</a>
</span><span class=lnt id=hl-34-7><a class=lnlinks href=#hl-34-7>  7</a>
</span><span class=lnt id=hl-34-8><a class=lnlinks href=#hl-34-8>  8</a>
</span><span class=lnt id=hl-34-9><a class=lnlinks href=#hl-34-9>  9</a>
</span><span class=lnt id=hl-34-10><a class=lnlinks href=#hl-34-10> 10</a>
</span><span class=lnt id=hl-34-11><a class=lnlinks href=#hl-34-11> 11</a>
</span><span class=lnt id=hl-34-12><a class=lnlinks href=#hl-34-12> 12</a>
</span><span class=lnt id=hl-34-13><a class=lnlinks href=#hl-34-13> 13</a>
</span><span class=lnt id=hl-34-14><a class=lnlinks href=#hl-34-14> 14</a>
</span><span class=lnt id=hl-34-15><a class=lnlinks href=#hl-34-15> 15</a>
</span><span class=lnt id=hl-34-16><a class=lnlinks href=#hl-34-16> 16</a>
</span><span class=lnt id=hl-34-17><a class=lnlinks href=#hl-34-17> 17</a>
</span><span class=lnt id=hl-34-18><a class=lnlinks href=#hl-34-18> 18</a>
</span><span class=lnt id=hl-34-19><a class=lnlinks href=#hl-34-19> 19</a>
</span><span class=lnt id=hl-34-20><a class=lnlinks href=#hl-34-20> 20</a>
</span><span class=lnt id=hl-34-21><a class=lnlinks href=#hl-34-21> 21</a>
</span><span class=lnt id=hl-34-22><a class=lnlinks href=#hl-34-22> 22</a>
</span><span class=lnt id=hl-34-23><a class=lnlinks href=#hl-34-23> 23</a>
</span><span class=lnt id=hl-34-24><a class=lnlinks href=#hl-34-24> 24</a>
</span><span class=lnt id=hl-34-25><a class=lnlinks href=#hl-34-25> 25</a>
</span><span class=lnt id=hl-34-26><a class=lnlinks href=#hl-34-26> 26</a>
</span><span class=lnt id=hl-34-27><a class=lnlinks href=#hl-34-27> 27</a>
</span><span class=lnt id=hl-34-28><a class=lnlinks href=#hl-34-28> 28</a>
</span><span class=lnt id=hl-34-29><a class=lnlinks href=#hl-34-29> 29</a>
</span><span class=lnt id=hl-34-30><a class=lnlinks href=#hl-34-30> 30</a>
</span><span class=lnt id=hl-34-31><a class=lnlinks href=#hl-34-31> 31</a>
</span><span class=lnt id=hl-34-32><a class=lnlinks href=#hl-34-32> 32</a>
</span><span class=lnt id=hl-34-33><a class=lnlinks href=#hl-34-33> 33</a>
</span><span class=lnt id=hl-34-34><a class=lnlinks href=#hl-34-34> 34</a>
</span><span class=lnt id=hl-34-35><a class=lnlinks href=#hl-34-35> 35</a>
</span><span class=lnt id=hl-34-36><a class=lnlinks href=#hl-34-36> 36</a>
</span><span class=lnt id=hl-34-37><a class=lnlinks href=#hl-34-37> 37</a>
</span><span class=lnt id=hl-34-38><a class=lnlinks href=#hl-34-38> 38</a>
</span><span class=lnt id=hl-34-39><a class=lnlinks href=#hl-34-39> 39</a>
</span><span class=lnt id=hl-34-40><a class=lnlinks href=#hl-34-40> 40</a>
</span><span class=lnt id=hl-34-41><a class=lnlinks href=#hl-34-41> 41</a>
</span><span class=lnt id=hl-34-42><a class=lnlinks href=#hl-34-42> 42</a>
</span><span class=lnt id=hl-34-43><a class=lnlinks href=#hl-34-43> 43</a>
</span><span class=lnt id=hl-34-44><a class=lnlinks href=#hl-34-44> 44</a>
</span><span class=lnt id=hl-34-45><a class=lnlinks href=#hl-34-45> 45</a>
</span><span class=lnt id=hl-34-46><a class=lnlinks href=#hl-34-46> 46</a>
</span><span class=lnt id=hl-34-47><a class=lnlinks href=#hl-34-47> 47</a>
</span><span class=lnt id=hl-34-48><a class=lnlinks href=#hl-34-48> 48</a>
</span><span class=lnt id=hl-34-49><a class=lnlinks href=#hl-34-49> 49</a>
</span><span class=lnt id=hl-34-50><a class=lnlinks href=#hl-34-50> 50</a>
</span><span class=lnt id=hl-34-51><a class=lnlinks href=#hl-34-51> 51</a>
</span><span class=lnt id=hl-34-52><a class=lnlinks href=#hl-34-52> 52</a>
</span><span class=lnt id=hl-34-53><a class=lnlinks href=#hl-34-53> 53</a>
</span><span class=lnt id=hl-34-54><a class=lnlinks href=#hl-34-54> 54</a>
</span><span class=lnt id=hl-34-55><a class=lnlinks href=#hl-34-55> 55</a>
</span><span class=lnt id=hl-34-56><a class=lnlinks href=#hl-34-56> 56</a>
</span><span class=lnt id=hl-34-57><a class=lnlinks href=#hl-34-57> 57</a>
</span><span class=lnt id=hl-34-58><a class=lnlinks href=#hl-34-58> 58</a>
</span><span class=lnt id=hl-34-59><a class=lnlinks href=#hl-34-59> 59</a>
</span><span class=lnt id=hl-34-60><a class=lnlinks href=#hl-34-60> 60</a>
</span><span class=lnt id=hl-34-61><a class=lnlinks href=#hl-34-61> 61</a>
</span><span class=lnt id=hl-34-62><a class=lnlinks href=#hl-34-62> 62</a>
</span><span class=lnt id=hl-34-63><a class=lnlinks href=#hl-34-63> 63</a>
</span><span class=lnt id=hl-34-64><a class=lnlinks href=#hl-34-64> 64</a>
</span><span class=lnt id=hl-34-65><a class=lnlinks href=#hl-34-65> 65</a>
</span><span class=lnt id=hl-34-66><a class=lnlinks href=#hl-34-66> 66</a>
</span><span class=lnt id=hl-34-67><a class=lnlinks href=#hl-34-67> 67</a>
</span><span class=lnt id=hl-34-68><a class=lnlinks href=#hl-34-68> 68</a>
</span><span class=lnt id=hl-34-69><a class=lnlinks href=#hl-34-69> 69</a>
</span><span class=lnt id=hl-34-70><a class=lnlinks href=#hl-34-70> 70</a>
</span><span class=lnt id=hl-34-71><a class=lnlinks href=#hl-34-71> 71</a>
</span><span class=lnt id=hl-34-72><a class=lnlinks href=#hl-34-72> 72</a>
</span><span class=lnt id=hl-34-73><a class=lnlinks href=#hl-34-73> 73</a>
</span><span class=lnt id=hl-34-74><a class=lnlinks href=#hl-34-74> 74</a>
</span><span class=lnt id=hl-34-75><a class=lnlinks href=#hl-34-75> 75</a>
</span><span class=lnt id=hl-34-76><a class=lnlinks href=#hl-34-76> 76</a>
</span><span class=lnt id=hl-34-77><a class=lnlinks href=#hl-34-77> 77</a>
</span><span class=lnt id=hl-34-78><a class=lnlinks href=#hl-34-78> 78</a>
</span><span class=lnt id=hl-34-79><a class=lnlinks href=#hl-34-79> 79</a>
</span><span class=lnt id=hl-34-80><a class=lnlinks href=#hl-34-80> 80</a>
</span><span class=lnt id=hl-34-81><a class=lnlinks href=#hl-34-81> 81</a>
</span><span class=lnt id=hl-34-82><a class=lnlinks href=#hl-34-82> 82</a>
</span><span class=lnt id=hl-34-83><a class=lnlinks href=#hl-34-83> 83</a>
</span><span class=lnt id=hl-34-84><a class=lnlinks href=#hl-34-84> 84</a>
</span><span class=lnt id=hl-34-85><a class=lnlinks href=#hl-34-85> 85</a>
</span><span class=lnt id=hl-34-86><a class=lnlinks href=#hl-34-86> 86</a>
</span><span class=lnt id=hl-34-87><a class=lnlinks href=#hl-34-87> 87</a>
</span><span class=lnt id=hl-34-88><a class=lnlinks href=#hl-34-88> 88</a>
</span><span class=lnt id=hl-34-89><a class=lnlinks href=#hl-34-89> 89</a>
</span><span class=lnt id=hl-34-90><a class=lnlinks href=#hl-34-90> 90</a>
</span><span class=lnt id=hl-34-91><a class=lnlinks href=#hl-34-91> 91</a>
</span><span class=lnt id=hl-34-92><a class=lnlinks href=#hl-34-92> 92</a>
</span><span class=lnt id=hl-34-93><a class=lnlinks href=#hl-34-93> 93</a>
</span><span class=lnt id=hl-34-94><a class=lnlinks href=#hl-34-94> 94</a>
</span><span class=lnt id=hl-34-95><a class=lnlinks href=#hl-34-95> 95</a>
</span><span class=lnt id=hl-34-96><a class=lnlinks href=#hl-34-96> 96</a>
</span><span class=lnt id=hl-34-97><a class=lnlinks href=#hl-34-97> 97</a>
</span><span class=lnt id=hl-34-98><a class=lnlinks href=#hl-34-98> 98</a>
</span><span class=lnt id=hl-34-99><a class=lnlinks href=#hl-34-99> 99</a>
</span><span class=lnt id=hl-34-100><a class=lnlinks href=#hl-34-100>100</a>
</span><span class=lnt id=hl-34-101><a class=lnlinks href=#hl-34-101>101</a>
</span><span class=lnt id=hl-34-102><a class=lnlinks href=#hl-34-102>102</a>
</span><span class=lnt id=hl-34-103><a class=lnlinks href=#hl-34-103>103</a>
</span><span class=lnt id=hl-34-104><a class=lnlinks href=#hl-34-104>104</a>
</span><span class=lnt id=hl-34-105><a class=lnlinks href=#hl-34-105>105</a>
</span><span class=lnt id=hl-34-106><a class=lnlinks href=#hl-34-106>106</a>
</span><span class=lnt id=hl-34-107><a class=lnlinks href=#hl-34-107>107</a>
</span><span class=lnt id=hl-34-108><a class=lnlinks href=#hl-34-108>108</a>
</span><span class=lnt id=hl-34-109><a class=lnlinks href=#hl-34-109>109</a>
</span><span class=lnt id=hl-34-110><a class=lnlinks href=#hl-34-110>110</a>
</span><span class=lnt id=hl-34-111><a class=lnlinks href=#hl-34-111>111</a>
</span><span class=lnt id=hl-34-112><a class=lnlinks href=#hl-34-112>112</a>
</span><span class=lnt id=hl-34-113><a class=lnlinks href=#hl-34-113>113</a>
</span><span class=lnt id=hl-34-114><a class=lnlinks href=#hl-34-114>114</a>
</span><span class=lnt id=hl-34-115><a class=lnlinks href=#hl-34-115>115</a>
</span><span class=lnt id=hl-34-116><a class=lnlinks href=#hl-34-116>116</a>
</span><span class=lnt id=hl-34-117><a class=lnlinks href=#hl-34-117>117</a>
</span><span class=lnt id=hl-34-118><a class=lnlinks href=#hl-34-118>118</a>
</span><span class=lnt id=hl-34-119><a class=lnlinks href=#hl-34-119>119</a>
</span><span class=lnt id=hl-34-120><a class=lnlinks href=#hl-34-120>120</a>
</span><span class=lnt id=hl-34-121><a class=lnlinks href=#hl-34-121>121</a>
</span><span class=lnt id=hl-34-122><a class=lnlinks href=#hl-34-122>122</a>
</span><span class=lnt id=hl-34-123><a class=lnlinks href=#hl-34-123>123</a>
</span><span class=lnt id=hl-34-124><a class=lnlinks href=#hl-34-124>124</a>
</span><span class=lnt id=hl-34-125><a class=lnlinks href=#hl-34-125>125</a>
</span><span class=lnt id=hl-34-126><a class=lnlinks href=#hl-34-126>126</a>
</span><span class=lnt id=hl-34-127><a class=lnlinks href=#hl-34-127>127</a>
</span><span class=lnt id=hl-34-128><a class=lnlinks href=#hl-34-128>128</a>
</span><span class=lnt id=hl-34-129><a class=lnlinks href=#hl-34-129>129</a>
</span><span class=lnt id=hl-34-130><a class=lnlinks href=#hl-34-130>130</a>
</span><span class=lnt id=hl-34-131><a class=lnlinks href=#hl-34-131>131</a>
</span><span class=lnt id=hl-34-132><a class=lnlinks href=#hl-34-132>132</a>
</span><span class=lnt id=hl-34-133><a class=lnlinks href=#hl-34-133>133</a>
</span><span class=lnt id=hl-34-134><a class=lnlinks href=#hl-34-134>134</a>
</span><span class=lnt id=hl-34-135><a class=lnlinks href=#hl-34-135>135</a>
</span><span class=lnt id=hl-34-136><a class=lnlinks href=#hl-34-136>136</a>
</span><span class=lnt id=hl-34-137><a class=lnlinks href=#hl-34-137>137</a>
</span><span class=lnt id=hl-34-138><a class=lnlinks href=#hl-34-138>138</a>
</span><span class=lnt id=hl-34-139><a class=lnlinks href=#hl-34-139>139</a>
</span><span class=lnt id=hl-34-140><a class=lnlinks href=#hl-34-140>140</a>
</span><span class=lnt id=hl-34-141><a class=lnlinks href=#hl-34-141>141</a>
</span><span class=lnt id=hl-34-142><a class=lnlinks href=#hl-34-142>142</a>
</span><span class=lnt id=hl-34-143><a class=lnlinks href=#hl-34-143>143</a>
</span><span class=lnt id=hl-34-144><a class=lnlinks href=#hl-34-144>144</a>
</span><span class=lnt id=hl-34-145><a class=lnlinks href=#hl-34-145>145</a>
</span><span class=lnt id=hl-34-146><a class=lnlinks href=#hl-34-146>146</a>
</span><span class=lnt id=hl-34-147><a class=lnlinks href=#hl-34-147>147</a>
</span><span class=lnt id=hl-34-148><a class=lnlinks href=#hl-34-148>148</a>
</span><span class=lnt id=hl-34-149><a class=lnlinks href=#hl-34-149>149</a>
</span><span class=lnt id=hl-34-150><a class=lnlinks href=#hl-34-150>150</a>
</span><span class=lnt id=hl-34-151><a class=lnlinks href=#hl-34-151>151</a>
</span><span class=lnt id=hl-34-152><a class=lnlinks href=#hl-34-152>152</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># feed/tasks.py</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>celery</span> <span class=kn>import</span> <span class=n>shared_task</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>timedelta</span><span class=p>,</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>django.utils</span> <span class=kn>import</span> <span class=n>timezone</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>django.core.mail</span> <span class=kn>import</span> <span class=n>send_mail</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>feed.utils</span> <span class=kn>import</span> <span class=n>send_mail_test</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@shared_task</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>daily_news_feed</span><span class=p>(</span><span class=n>user_ids</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    执行每日新闻推送任务
</span></span></span><span class=line><span class=cl><span class=s2>    推送自上次推送以来关注标签下的新新闻
</span></span></span><span class=line><span class=cl><span class=s2>    :param user_ids: 用户ID列表，若为None则推送所有用户
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 延迟导入模型</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>feed.models</span> <span class=kn>import</span> <span class=n>FeedLog</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>user.models</span> <span class=kn>import</span> <span class=n>SysUser</span><span class=p>,</span> <span class=n>UserLike</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>news.models</span> <span class=kn>import</span> <span class=n>News</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>now</span> <span class=o>=</span> <span class=n>timezone</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;开始执行每日新闻推送任务&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>user_ids</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>users</span> <span class=o>=</span> <span class=n>SysUser</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>users</span> <span class=o>=</span> <span class=n>SysUser</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>id__in</span><span class=o>=</span><span class=n>user_ids</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>user</span> <span class=ow>in</span> <span class=n>users</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>last_log</span> <span class=o>=</span> <span class=n>FeedLog</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>user</span><span class=o>=</span><span class=n>user</span><span class=p>)</span><span class=o>.</span><span class=n>latest</span><span class=p>(</span><span class=s1>&#39;send_time&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>last_sent_time</span> <span class=o>=</span> <span class=n>last_log</span><span class=o>.</span><span class=n>send_time</span> <span class=c1># 获取上次推送时间</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=n>FeedLog</span><span class=o>.</span><span class=n>DoesNotExist</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>last_sent_time</span> <span class=o>=</span> <span class=n>now</span> <span class=o>-</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span> <span class=c1># 新用户无推送记录，则将推送时间设置为当前时间减去1天</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>liked_tags</span> <span class=o>=</span> <span class=n>UserLike</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>user</span><span class=o>=</span><span class=n>user</span><span class=p>)</span><span class=o>.</span><span class=n>values_list</span><span class=p>(</span><span class=s1>&#39;tag_id&#39;</span><span class=p>,</span> <span class=n>flat</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>liked_tags</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;用户 </span><span class=si>{</span><span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=si>}</span><span class=s2> 未设置兴趣标签，跳过推送&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>new_news</span> <span class=o>=</span> <span class=n>News</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>pub_time__gte</span><span class=o>=</span><span class=n>last_sent_time</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>newstag__tag_id__in</span><span class=o>=</span><span class=n>liked_tags</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span><span class=o>.</span><span class=n>distinct</span><span class=p>()</span><span class=o>.</span><span class=n>order_by</span><span class=p>(</span><span class=s1>&#39;-pub_time&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>count</span> <span class=o>=</span> <span class=n>new_news</span><span class=o>.</span><span class=n>count</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;用户 </span><span class=si>{</span><span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=si>}</span><span class=s2> 新闻数量：</span><span class=si>{</span><span class=n>count</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>count</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;用户 </span><span class=si>{</span><span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=si>}</span><span class=s2> 无新新闻可推送&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 创建推送记录</span>
</span></span><span class=line><span class=cl>        <span class=n>feed_logs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>news</span> <span class=ow>in</span> <span class=n>new_news</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>feed_logs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>FeedLog</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>user</span><span class=o>=</span><span class=n>user</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>news</span><span class=o>=</span><span class=n>news</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>title</span><span class=o>=</span><span class=n>news</span><span class=o>.</span><span class=n>title</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>summary</span><span class=o>=</span><span class=n>news</span><span class=o>.</span><span class=n>summary</span> <span class=ow>or</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>status</span><span class=o>=</span><span class=s1>&#39;pending&#39;</span>
</span></span><span class=line><span class=cl>            <span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>FeedLog</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>bulk_create</span><span class=p>(</span><span class=n>feed_logs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 邮件发送后记录需要更新的状态</span>
</span></span><span class=line><span class=cl>        <span class=n>success_logs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>failed_logs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>log</span> <span class=ow>in</span> <span class=n>feed_logs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>subject</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;【</span><span class=si>{</span><span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=si>}</span><span class=s2>】今日新闻推送&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>                标题：</span><span class=si>{</span><span class=n>log</span><span class=o>.</span><span class=n>title</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>                摘要：</span><span class=si>{</span><span class=n>log</span><span class=o>.</span><span class=n>summary</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>                发布时间：</span><span class=si>{</span><span class=n>log</span><span class=o>.</span><span class=n>news</span><span class=o>.</span><span class=n>pub_time</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>                &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>from_email</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;EMAIL_HOST_USER&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>recipient_list</span> <span class=o>=</span> <span class=p>[</span><span class=n>user</span><span class=o>.</span><span class=n>email</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>send_mail</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>subject</span><span class=o>=</span><span class=n>subject</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>message</span><span class=o>=</span><span class=n>message</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>from_email</span><span class=o>=</span><span class=n>from_email</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>recipient_list</span><span class=o>=</span><span class=n>recipient_list</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>fail_silently</span><span class=o>=</span><span class=kc>False</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>success_logs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>log</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;推送失败给用户 </span><span class=si>{</span><span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=si>}</span><span class=s2>，错误：</span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>log</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=s1>&#39;failed&#39;</span>
</span></span><span class=line><span class=cl>                <span class=n>failed_logs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>log</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 批量更新成功发送的日志</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>success_logs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>FeedLog</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>id__in</span><span class=o>=</span><span class=p>[</span><span class=n>log</span><span class=o>.</span><span class=n>id</span> <span class=k>for</span> <span class=n>log</span> <span class=ow>in</span> <span class=n>success_logs</span><span class=p>])</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>status</span><span class=o>=</span><span class=s1>&#39;sent&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 批量更新发送失败的日志（如果需要区分）</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>failed_logs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>FeedLog</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>id__in</span><span class=o>=</span><span class=p>[</span><span class=n>log</span><span class=o>.</span><span class=n>id</span> <span class=k>for</span> <span class=n>log</span> <span class=ow>in</span> <span class=n>failed_logs</span><span class=p>])</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>status</span><span class=o>=</span><span class=s1>&#39;failed&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;每日新闻推送任务完成&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@shared_task</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_and_send_news_feed</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    每分钟检查用户是否到达 feedtime，如果匹配，则触发推送
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>user.models</span> <span class=kn>import</span> <span class=n>SysUser</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>now</span> <span class=o>=</span> <span class=n>timezone</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;正在检查是否满足推送条件，当前时间：</span><span class=si>{</span><span class=n>now</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>users</span> <span class=o>=</span> <span class=n>SysUser</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>triggered_users</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>user</span> <span class=ow>in</span> <span class=n>users</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>feed_time</span> <span class=o>=</span> <span class=n>user</span><span class=o>.</span><span class=n>feedtime</span>
</span></span><span class=line><span class=cl>        <span class=n>today</span> <span class=o>=</span> <span class=n>now</span><span class=o>.</span><span class=n>date</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>target_time</span> <span class=o>=</span> <span class=n>timezone</span><span class=o>.</span><span class=n>make_aware</span><span class=p>(</span><span class=n>datetime</span><span class=o>.</span><span class=n>combine</span><span class=p>(</span><span class=n>today</span><span class=p>,</span> <span class=n>feed_time</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>delta</span> <span class=o>=</span> <span class=p>(</span><span class=n>now</span> <span class=o>-</span> <span class=n>target_time</span><span class=p>)</span><span class=o>.</span><span class=n>total_seconds</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 判断当前时间是否在用户 feedtime 的 ±1 分钟内</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>abs</span><span class=p>(</span><span class=n>delta</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>60</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>triggered_users</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>triggered_users</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;将为以下用户发送新闻推送：</span><span class=si>{</span><span class=p>[</span><span class=n>u</span><span class=o>.</span><span class=n>username</span> <span class=k>for</span> <span class=n>u</span> <span class=ow>in</span> <span class=n>triggered_users</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>daily_news_feed</span><span class=o>.</span><span class=n>delay</span><span class=p>(</span><span class=n>user_ids</span><span class=o>=</span><span class=p>[</span><span class=n>u</span><span class=o>.</span><span class=n>id</span> <span class=k>for</span> <span class=n>u</span> <span class=ow>in</span> <span class=n>triggered_users</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;没有用户需要推送&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 注册定时任务（运行 manage.py runserver 时自动加载）</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>celery</span> <span class=kn>import</span> <span class=n>current_app</span> <span class=k>as</span> <span class=n>celery</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@celery.on_after_configure.connect</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>setup_periodic_tasks</span><span class=p>(</span><span class=n>sender</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sender</span><span class=o>.</span><span class=n>add_periodic_task</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>timedelta</span><span class=p>(</span><span class=n>minutes</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>  <span class=c1># 每分钟检查一次</span>
</span></span><span class=line><span class=cl>        <span class=n>check_and_send_news_feed</span><span class=o>.</span><span class=n>s</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>name</span><span class=o>=</span><span class=s1>&#39;每分钟检查用户推送时间&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p><img src=/imgs/img-lazy-loading.gif data-src=image-15.png alt="alt text"></p><h3 id=时区问题>时区问题
<a class=header-anchor href=#%e6%97%b6%e5%8c%ba%e9%97%ae%e9%a2%98></a></h3><blockquote><p>参考博客：
<a href=https://blog.csdn.net/qq_41341757/article/details/109319850 title=https://blog.csdn.net/qq_41341757/article/details/109319850 rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://blog.csdn.net/qq_41341757/article/details/109319850
<i class="fa fa-external-link-alt"></i></a></p></blockquote><p>面对依赖时间的任务，绕不开时区问题。在Django项目中，一般这样处理</p><ul><li>前端传来的时间数据，在数据库中以UTC保存</li><li>后端处理时，统一用UTC为标准</li></ul><p>在 settings.py 中，设置USE_TZ = True，TIME_ZONE = &lsquo;Asia/Shanghai&rsquo; ，在涉及时区处理时候，Django将自动转换</p><h2 id=修改推送设置>修改推送设置
<a class=header-anchor href=#%e4%bf%ae%e6%94%b9%e6%8e%a8%e9%80%81%e8%ae%be%e7%bd%ae></a></h2><p>为简单处理（同时也考虑到真实情况），舍弃原定的频率（每日/每周/每月）并统一为每日推送，保留用户可修改具体的推送时间的功能。</p><h1 id=获取用户信息不包含敏感信息>获取用户信息（不包含敏感信息）
<a class=header-anchor href=#%e8%8e%b7%e5%8f%96%e7%94%a8%e6%88%b7%e4%bf%a1%e6%81%af%e4%b8%8d%e5%8c%85%e5%90%ab%e6%95%8f%e6%84%9f%e4%bf%a1%e6%81%af></a></h1><p>主要为了方便前端</p></div><footer class=post-footer><div class=post-tags><a href=/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/>软件工程
</a><a href=/tags/django/>Django</a></div><div class=post-share-tools><div class=post-share-loading><i class="fa-solid fa-ellipsis fa-spin"></i></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class=a2a_dd href=https://www.addtoany.com/share></a><a class=a2a_button_wechat></a><a class=a2a_button_qzone></a><a class=a2a_button_sina_weibo></a><a class=a2a_button_douban></a><a class=a2a_button_facebook></a><a class=a2a_button_x></a><a class=a2a_button_email></a><a class=a2a_button_printfriendly></a></div></div><hr><div class=reward-container><div><i class="fa-solid fa-mug-hot"></i>请我喝杯咖啡吧 ヾ(^▽^*)))</div><button>
赞赏</button><div class=post-reward><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/ali-pay.png alt="eSparkL - 支付宝">
<span>支付宝</span></div><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/wechat-pay.png alt="eSparkL - 微信">
<span>微信</span></div></div></div><div class=post-copyright><img src=/imgs/cc/cc.svg class=cc-icon width=75 height=75 align=right alt=共享知识 title=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
新闻推荐系统后端</li><li class=post-copyright-author><strong>本文作者： </strong>eSparkL</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://eSparkL.github.io/study/10-%E6%96%B0%E9%97%BB%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%90%8E%E7%AB%AF/ title=新闻推荐系统后端>https://eSparkL.github.io/study/10-%E6%96%B0%E9%97%BB%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%90%8E%E7%AB%AF/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本作品采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans>BY-NC-SA</a> 许可协议。转载请注明出处！</li><li><div class=license-icons><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans target=_blank><img src=/imgs/cc/big/by_nc_sa.svg alt=BY-NC-SA title=BY-NC-SA>
</a><a href=https://notbyai.fyi target=_blank><img src=/imgs/notbyai/zh-hans/white.svg title="Not By AI"></a></div></li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=/images/wechat_channel.jpg><span class=icon><i class="fab fa-weixin"></i>
</span><span class=label>WeChat</span></a></div><div class=social-item><a target=_blank class=social-link href=/rss.xml><span class=icon><i class="fa fa-rss"></i>
</span><span class=label>RSS</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/study/11-%E6%8A%A5%E9%94%99%E5%B0%8F%E4%BB%93%E5%BA%93/ rel=next title=报错小仓库（持续更新）><i class="fa fa-chevron-left"></i> 报错小仓库（持续更新）</a></div><div class="post-nav-prev post-nav-item"><a href=/study/9-%E6%A6%82%E7%8E%87%E8%AE%BA-%E7%AC%AC%E4%B8%89%E7%AB%A0%E7%AC%94%E8%AE%B0/ rel=prev title=概率论-第三章笔记>概率论-第三章笔记
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div id=i18n-translate class=i18n-translate><i class="fa fa-language"></i><div id=lang-select class=lang-select><div id=lang-selected class=selected-option><span class="flag-icon flag-icon-zh-cn"></span>
<span class=selected-language>简体中文</span>
<i class="fa fa-chevron-down"></i></div><div id=lang-options class=lang-options><div class=lang-option lang-code=zh-cn lang-name=简体中文 lang-url=/study/10-%E6%96%B0%E9%97%BB%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%90%8E%E7%AB%AF/><span class="flag-icon flag-icon-zh-cn"></span>
<span class=lang-name>简体中文</span></div></div></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>eSparkL</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.147.1 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.7.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>粤ICP备 18047355-1 号</a>
<img src=/imgs/gongan.png alt=沪公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31011402009770" target=_blank>沪公网安备 31011402009770 号</a></div><div class=vendors-list><a target=_blank href=https://vercel.com title=Vercel><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/vercel.svg alt=Vercel>
</a><a target=_blank href=https://upyun.com title=又拍云><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/upyun.png alt=又拍云>
</a><a target=_blank href=https://github.com title=Github><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/github.svg alt=Github>
</a><span>提供CDN/云资源支持</span></div><div class=custom-footer>Website source code <a href=https://github.com/hugo-next/hugo-theme-next/blob/develop/exampleSite/layouts/partials/custom_footer.html target=_blank>here</a></div></div></footer><script class=next-config data-name=page type=application/json>{"clipboard":{"js":{"alias":"clipboard","file":"dist/clipboard.min.js","name":"clipboard.js","version":"2.0.11"}},"comments":false,"expired":false,"isHome":false,"isPage":true,"math":{"js":{"file":"es5/tex-mml-svg.js","name":"mathjax","version":"3.2.2"},"render":"mathjax"},"path":"10-%E6%96%B0%E9%97%BB%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%90%8E%E7%AB%AF","permalink":"https://eSparkL.github.io/study/10-%E6%96%B0%E9%97%BB%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%90%8E%E7%AB%AF/","title":"新闻推荐系统后端","toc":true,"waline":{"commentcnt":{"alias":"@waline/client","alias_name":"waline","file":"dist/comment.js","name":"comment","version":"2.15.8"}}}</script><script type=text/javascript src=https://eSparkL.github.io/js/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=https://eSparkL.github.io/js/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#ff6347","enable":true,"save":"manual"},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://eSparkL.github.io/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"isMultiLang":true,"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"slideInRight","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":true,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","share":{"addtoany":{"js":"https://static.addtoany.com/menu/page.js","locale":"zh-CN","num":8},"enable":true},"sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"twikoo":{"cfg":{"envid":"http://192.168.31.50:8080","region":"ap-guangzhou"},"js":{"file":"dist/twikoo.all.min.js","name":"twikoo","version":"1.6.41"}},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"https://eSparkL.github.io/js/3rd"}},"version":"4.7.3","waline":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"@waline/client","file":"dist/waline.css","name":"waline","version":"2.15.8"},"js":{"alias":"@waline/client","file":"dist/waline.js","name":"waline","version":"2.15.8"}}}</script><script type=text/javascript src="/js/main.min.js?=1748535996" defer></script><script type=text/javascript src="/js/clipboard.min.js?=1748535998" defer></script><script type=text/javascript src="/js/math.min.js?=1748535998" defer></script></body></html>